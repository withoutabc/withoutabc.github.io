<!-- build time:Mon Mar 25 2024 21:17:20 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="镜玄的博客" href="https://withoutabc.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="镜玄的博客" href="https://withoutabc.github.io/atom.xml"><link rel="alternate" type="application/json" title="镜玄的博客" href="https://withoutabc.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://withoutabc.github.io/2024/03/15/LLM-Langchain%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/"><title>LLM&Langchain————大模型应用开发 | 寄寄菜鸟试飞点 = 镜玄的博客 = 某个INTJ的领域</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">LLM&Langchain————大模型应用开发</h1><div class="meta"><span class="item" title="创建时间：2024-03-15 15:05:41"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-03-15T15:05:41+08:00">2024-03-15</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>13k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>12 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">寄寄菜鸟试飞点</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/07/24/ERKTmSBrWPqz1H9.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/24/xKd198wlCvUYLPh.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/26/F85HJnp2CPtwWST.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/24/SsZLNvVkAe9j4id.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/26/3JHmkzeDNjrOT6B.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/24/VEqHsuJXPzaoWfr.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://withoutabc.github.io/2024/03/15/LLM-Langchain%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="镜玄"><meta itemprop="description" content="某个INTJ的领域, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="镜玄的博客"></span><div class="body md" itemprop="articleBody"><h1 id="大模型简介"><a class="anchor" href="#大模型简介">#</a> 大模型简介</h1><ul><li>LLM： <code>Large Language Model</code></li><li>自然语言处理、信息检索、计算机视觉</li><li>大家应该用的多，比较了解</li></ul><h1 id="调用大模型api百度文心为例"><a class="anchor" href="#调用大模型api百度文心为例">#</a> 调用大模型 API（百度文心为例）</h1><p>调用流程文档：<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC5iYWlkdS5jb20vZG9jL1dFTlhJTldPUktTSE9QL3MveWxvaWViMDF0">https://cloud.baidu.com/doc/WENXINWORKSHOP/s/yloieb01t</span></p><ol><li>点击百度智能云千帆控制台，此时需要注册 / 登录，注册后可能需要实名认证。</li></ol><p><img data-src="https://s2.loli.net/2024/03/25/WK1mcQ4LYhwU9rH.png" alt="2024-03-25 21:02:51"></p><ol start="2"><li>点击应用接入，选择创建应用。</li></ol><p><img data-src="https://s2.loli.net/2024/03/25/wtU9MrDTQzRXlLE.png" alt="2024-03-25 21:02:51"></p><ol start="3"><li>设置</li></ol><p><img data-src="https://s2.loli.net/2024/03/25/z2THDJeotwBRqb5.png" alt="2024-03-25 21:02:51"></p><ol start="4"><li>保存</li></ol><p><img data-src="https://s2.loli.net/2024/03/25/4l6P1AdbDOsWVuG.png" alt="2024-03-25 21:02:51"></p><ol start="5"><li>发送请求</li></ol><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 先获取 access_token, 再用 access_token 进行问答 </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 把 &#123;api_key&#125; 和 &#123;secret_key&#125; 替换成自己的，需保证网络正常</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> json</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">def</span> <span class="token function">get_access_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token triple-quoted-string string">"""</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    使用 API Key，Secret Key 获取access_token，替换下列示例中的应用API Key、应用Secret Key</pre></td></tr><tr><td data-num="9"></td><td><pre>    """</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment"># 指定网址</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    url <span class="token operator">=</span> <span class="token string">"https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&amp;client_id=&#123;api_key&#125;&amp;client_secret=&#123;secret_key&#125;"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment"># 设置 POST 访问</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    payload <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment"># 通过 POST 访问获取账户对应的 access_token</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">def</span> <span class="token function">get_wenxin</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment"># 调用接口</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    url <span class="token operator">=</span> <span class="token string">"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/eb-instant?access_token=&#123;access_token&#125;"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment"># 配置 POST 参数</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    payload <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token string">"messages"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span><span class="token comment"># user prompt</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token comment"># 输入的 prompt</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment"># 发起请求</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment"># 返回的是一个 Json 字符串</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    js <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>js<span class="token punctuation">[</span><span class="token string">"result"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><blockquote><p>也可以自己试试 OpenAI 的 API 接口调用： <span class="exturl" data-url="aHR0cHM6Ly9wbGF0Zm9ybS5vcGVuYWkuY29tLw==">https://platform.openai.com/</span> （自行学习，每个厂家都有自己的调用方法，流程差不多）</p><p>因为国内服务器一般不能访问外网，所以大部分时候会使用国内厂家的大模型，自己本地学习的时候可以尝试 OpenAI。</p></blockquote><h1 id="langchain介绍"><a class="anchor" href="#langchain介绍">#</a> Langchain 介绍</h1><p><strong>LangChain 框架是一个开源工具，充分利用了大型语言模型的强大能力，以便开发各种下游应用。它的目标是为各种大型语言模型应用提供通用接口，从而简化应用程序的开发流程</strong>。</p><p>具体来说，LangChain 框架可以实现数据感知和环境互动，也就是说，它能够让语言模型<strong>与其他数据来源连接</strong>，并且允许语言模型与其所处的环境进行互动。</p><p>LangChain 主要由以下 6 个核心模块组成:</p><ul><li><strong>模型输入 / 输出（Model I/O）</strong>：与语言模型交互的接口。</li><li><strong>数据连接（Data connection）</strong>：与特定应用程序的数据进行交互的接口。</li><li><strong>链（Chains）</strong>：将组件组合实现端到端应用。</li><li><strong>记忆（Memory）</strong>：用于链的多次运行之间持久化应用程序状态。</li><li><strong>代理（Agents）</strong>：扩展模型的推理能力，用于复杂的应用的调用序列。</li><li><strong>回调（Callbacks）</strong>：扩展模型的推理能力，用于复杂的应用的调用序列。</li></ul><blockquote><p>前四个是我们的重点。</p></blockquote><h2 id="langchain核心组件详解"><a class="anchor" href="#langchain核心组件详解">#</a> Langchain 核心组件详解</h2><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9kYXRhd2hhbGVjaGluYS5naXRodWIuaW8vbGxtLXVuaXZlcnNlLyMvQzIvNy4lMjBsYW5nY2hhaW4lMjAlRTclQkIlODQlRTQlQkIlQjYlRTglQUYlQTYlRTglQTclQTM=">https://datawhalechina.github.io/llm-universe/#/C2/7. langchain 组件详解</span></p></blockquote><h3 id="模型输入输出"><a class="anchor" href="#模型输入输出">#</a> 模型输入 / 输出</h3><p><img data-src="https://s2.loli.net/2024/03/25/Nu3RHKtoUWYMGwq.png" alt="2024-03-25 21:02:51"></p><ul><li>可以对输入进行<strong>格式化</strong>（提前设置好模板，提问时只需输入模板中的变量）</li><li>可以对输出进行<strong>结构化处理</strong>（自定义）</li></ul><h3 id="数据连接"><a class="anchor" href="#数据连接">#</a> 数据连接</h3><ul><li>可以加入数据集（知识库），让模型<strong>检索</strong>这些内容后进行作答。</li><li>数据来源：各种格式文件、网址、（向量）数据库</li></ul><h3 id="链"><a class="anchor" href="#链">#</a> 链</h3><ul><li><strong>将多个大型语言模型进行链式组合，或与其他组件进行链式调用</strong></li></ul><h3 id="记忆"><a class="anchor" href="#记忆">#</a> 记忆</h3><ul><li>上下文</li></ul><h3 id="代理"><a class="anchor" href="#代理">#</a> 代理</h3><ul><li>让大模型借助外部能力</li></ul><h3 id="回调"><a class="anchor" href="#回调">#</a> 回调</h3><ul><li><p>函数执行完以后再回头调用你设置好的回调函数</p></li><li><p>用于日志记录、监视、<strong>流式处理</strong>（网站上几个字几个字往外冒的输出方式，而不是等到生成完才把结果显示给你）</p></li></ul><h1 id="实践"><a class="anchor" href="#实践">#</a> 实践</h1><blockquote><p>这部分会用到上面申请好的 key，平台可以免费用一些。不涉及大规模文本输入时，key 的价格也十分便宜。</p></blockquote><p>安装一下依赖</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>pip install langchain</pre></td></tr></table></figure><h2 id="环境变量配置"><a class="anchor" href="#环境变量配置">#</a> 环境变量配置</h2><p>调用每个大模型的时候都会要求有 <code>api-key</code> 或者类似的密钥，直接写在代码里显然不合适，因为如果你不小心推送到 <code>public</code> 的代码仓库就会被别人有机可乘。</p><p>一般在目录下创建一个文件 <code>.env</code> （这时 PyCharm 会提示有相关插件，可以安装一下）</p><pre><code class="language-.env"># 删除注释
# 文件格式举例，字符串可以不用加双引号。
# 以下是OPENAI的格式
OPENAI_API_KEY=xxx
OPENAI_BASE_URL=xxx  # 非必需，如果你有中转地址，可以填这个
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=https://127.0.0.1:7890
# 以下为百度文心的格式
QIANFAN_AK=xxx
QIANFAN_SK=xxx
</code></pre><p>代码中用这种方式加载：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</pre></td></tr><tr><td data-num="2"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 如果要获取的话</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> openai</pre></td></tr><tr><td data-num="7"></td><td><pre>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'OPENAI_API_KEY'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 以下即使不设置，也会自己去环境变量找对应的</span></pre></td></tr><tr><td data-num="9"></td><td><pre>openai<span class="token punctuation">.</span>api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'OPENAI_API_KEY'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>openai<span class="token punctuation">.</span>base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'OPENAI_BASE_URL'</span><span class="token punctuation">]</span></pre></td></tr></table></figure><h2 id="提问"><a class="anchor" href="#提问">#</a> 提问</h2><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># wenxin_predict.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>llm <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"ERNIE-Bot"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>res <span class="token operator">=</span> llm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token string">"早上好"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 早上好！祝您今天一切顺利，心情愉悦，工作顺利，生活美满。如果您有任何问题或需要帮助，请随时告诉我，我将竭诚为您服务。</span></pre></td></tr></table></figure><h2 id="链-2"><a class="anchor" href="#链-2">#</a> 链</h2><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> SimpleSequentialChain<span class="token punctuation">,</span> LLMChain</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> ChatPromptTemplate</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>llm <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"ERNIE-Bot"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 创建两个子链</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 提示模板 1 ：这个提示将接受产品并返回最佳名称来描述该公司</span></pre></td></tr><tr><td data-num="15"></td><td><pre>first_prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token string">"描述制造&#123;product&#125;的一个公司的最好的名称是什么"</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>chain_one <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>first_prompt<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 提示模板 2 ：接受公司名称，然后输出该公司的长为 20 个单词的描述</span></pre></td></tr><tr><td data-num="21"></td><td><pre>second_prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    "写一个<span class="token number">20</span>字的描述对于下面这个\</pre></td></tr><tr><td data-num="23"></td><td><pre>    公司：<span class="token punctuation">&#123;</span>company_name<span class="token punctuation">&#125;</span>的"</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>chain_two <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>second_prompt<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># 构建简单顺序链</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 现在我们可以组合两个 LLMChain，以便我们可以在一个步骤中创建公司名称和描述</span></pre></td></tr><tr><td data-num="29"></td><td><pre>overall_simple_chain <span class="token operator">=</span> SimpleSequentialChain<span class="token punctuation">(</span>chains<span class="token operator">=</span><span class="token punctuation">[</span>chain_one<span class="token punctuation">,</span> chain_two<span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># 运行简单顺序链</span></pre></td></tr><tr><td data-num="32"></td><td><pre>product <span class="token operator">=</span> <span class="token string">"大号床单套装"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>overall_simple_chain<span class="token punctuation">.</span>run<span class="token punctuation">(</span>product<span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="个性化template"><a class="anchor" href="#个性化template">#</a> 个性化 Template</h2><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> ChatPromptTemplate</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 这里我们要求模型对给定文本进行中文翻译</span></pre></td></tr><tr><td data-num="4"></td><td><pre>template_string <span class="token operator">=</span> <span class="token triple-quoted-string string">"""Translate the text \</span></pre></td></tr><tr><td data-num="5"></td><td><pre>that is delimited by triple backticks \</pre></td></tr><tr><td data-num="6"></td><td><pre>into a Chinese. \</pre></td></tr><tr><td data-num="7"></td><td><pre>text: ```&#123;text&#125;```</pre></td></tr><tr><td data-num="8"></td><td><pre>"""</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 接着将 Template 实例化</span></pre></td></tr><tr><td data-num="11"></td><td><pre>chat_template <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span>template_string<span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="大模型开发流程"><a class="anchor" href="#大模型开发流程">#</a> 大模型开发流程</h1><p>这个部分是一个<strong>典型流程</strong>，覆盖了一些主要的东西。</p><p>目的是让大模型根据已有知识库做出回答，防止大模型针对部分问题推理出错误答案。</p><h2 id="知识库文档处理"><a class="anchor" href="#知识库文档处理">#</a> 知识库文档处理</h2><h3 id="文档加载"><a class="anchor" href="#文档加载">#</a> 文档加载</h3><h4 id="pdf文档"><a class="anchor" href="#pdf文档">#</a> PDF 文档</h4><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> PyMuPDFLoader</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 创建一个 PyMuPDFLoader Class 实例，输入为待加载的 pdf 文档路径</span></pre></td></tr><tr><td data-num="4"></td><td><pre>loader <span class="token operator">=</span> PyMuPDFLoader<span class="token punctuation">(</span><span class="token string">"文档路径"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 调用 PyMuPDFLoader Class 的函数 load 对 pdf 文件进行加载</span></pre></td></tr><tr><td data-num="7"></td><td><pre>pages <span class="token operator">=</span> loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"载入后的变量类型为：</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">type</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">，"</span></span><span class="token punctuation">,</span>  <span class="token string-interpolation"><span class="token string">f"该 PDF 一共包含 </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> 页"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>page <span class="token operator">=</span> pages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"每一个元素的类型：</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">type</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token string-interpolation"><span class="token string">f"该文档的描述性数据：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>page<span class="token punctuation">.</span>metadata<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token string-interpolation"><span class="token string">f"查看该文档的内容:\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>page<span class="token punctuation">.</span>page_content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token format-spec">1000]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>    sep<span class="token operator">=</span><span class="token string">"\n------\n"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><blockquote><p>可以注意一下 Document 的数据结构是怎么构成的，对自定义处理有帮助</p></blockquote><h4 id="md文档"><a class="anchor" href="#md文档">#</a> MD 文档</h4><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> UnstructuredMarkdownLoader</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>loader <span class="token operator">=</span> UnstructuredMarkdownLoader<span class="token punctuation">(</span><span class="token string">"文档路径"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>pages <span class="token operator">=</span> loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"载入后的变量类型为：</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">type</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">，"</span></span><span class="token punctuation">,</span>  <span class="token string-interpolation"><span class="token string">f"该 Markdown 一共包含 </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> 页"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>page <span class="token operator">=</span> pages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"每一个元素的类型：</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">type</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token string-interpolation"><span class="token string">f"该文档的描述性数据：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>page<span class="token punctuation">.</span>metadata<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token string-interpolation"><span class="token string">f"查看该文档的内容:\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>page<span class="token punctuation">.</span>page_content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token format-spec">]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="12"></td><td><pre>    sep<span class="token operator">=</span><span class="token string">"\n------\n"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="文档分割"><a class="anchor" href="#文档分割">#</a> 文档分割</h3><p>Langchain 中文本分割器都根据 <code>chunk_size</code> (块大小) 和 <code>chunk_overlap</code> (块与块之间的重叠大小) 进行分割。</p><p><img data-src="https://datawhalechina.github.io/llm-universe/figures/example-splitter.png" alt="image.png"></p><ul><li>chunk_size 指每个块包含的字符或 Token（如单词、句子等）的数量</li><li>chunk_overlap 指两个块之间共享的字符数量，用于保持上下文的连贯性，避免分割丢失上下文信息</li></ul><p>Langchain 提供多种文档分割方式，区别在怎么确定块与块之间的边界、块由哪些字符 /token 组成、以及如何测量块大小</p><ul><li>RecursiveCharacterTextSplitter (): 按字符串分割文本，递归地尝试按不同的分隔符进行分割文本。</li><li>CharacterTextSplitter (): 按字符来分割文本。</li><li>MarkdownHeaderTextSplitter (): 基于指定的标题来分割 markdown 文件。</li><li>TokenTextSplitter (): 按 token 来分割文本。</li><li>SentenceTransformersTokenTextSplitter (): 按 token 来分割文本。</li><li>Language (): 用于 CPP、Python、Ruby、Markdown 等。</li><li>NLTKTextSplitter (): 使用 NLTK（自然语言工具包）按句子分割文本。</li><li>SpacyTextSplitter (): 使用 Spacy 按句子的切割文本。</li></ul><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token triple-quoted-string string">''' </span></pre></td></tr><tr><td data-num="2"></td><td><pre>* RecursiveCharacterTextSplitter 递归字符文本分割</pre></td></tr><tr><td data-num="3"></td><td><pre>RecursiveCharacterTextSplitter 将按不同的字符递归地分割(按照这个优先级["\n\n", "\n", " ", ""])，</pre></td></tr><tr><td data-num="4"></td><td><pre>    这样就能尽量把所有和语义相关的内容尽可能长时间地保留在同一位置</pre></td></tr><tr><td data-num="5"></td><td><pre>RecursiveCharacterTextSplitter需要关注的是4个参数：</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>* separators - 分隔符字符串数组</pre></td></tr><tr><td data-num="8"></td><td><pre>* chunk_size - 每个文档的字符数量限制</pre></td></tr><tr><td data-num="9"></td><td><pre>* chunk_overlap - 两份文档重叠区域的长度</pre></td></tr><tr><td data-num="10"></td><td><pre>* length_function - 长度计算函数</pre></td></tr><tr><td data-num="11"></td><td><pre>'''</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#导入文本分割器</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter</pre></td></tr></table></figure><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 知识库中单段文本长度</span></pre></td></tr><tr><td data-num="2"></td><td><pre>CHUNK_SIZE <span class="token operator">=</span> <span class="token number">500</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 知识库中相邻文本重合长度</span></pre></td></tr><tr><td data-num="5"></td><td><pre>OVERLAP_SIZE <span class="token operator">=</span> <span class="token number">50</span></pre></td></tr></table></figure><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 此处我们使用 PDF 文件作为示例</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> PyMuPDFLoader</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 创建一个 PyMuPDFLoader Class 实例，输入为待加载的 pdf 文档路径</span></pre></td></tr><tr><td data-num="5"></td><td><pre>loader <span class="token operator">=</span> PyMuPDFLoader<span class="token punctuation">(</span><span class="token string">"../../data_base/knowledge_db/pumkin_book/pumpkin_book.pdf"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 调用 PyMuPDFLoader Class 的函数 load 对 pdf 文件进行加载</span></pre></td></tr><tr><td data-num="8"></td><td><pre>pages <span class="token operator">=</span> loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>page <span class="token operator">=</span> pages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 使用递归字符文本分割器</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> TokenTextSplitter</pre></td></tr><tr><td data-num="13"></td><td><pre>text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    chunk_size<span class="token operator">=</span>CHUNK_SIZE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    chunk_overlap<span class="token operator">=</span>OVERLAP_SIZE</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>text_splitter<span class="token punctuation">.</span>split_text<span class="token punctuation">(</span>page<span class="token punctuation">.</span>page_content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>split_docs <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>split_documents<span class="token punctuation">(</span>pages<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"切分后的文件数量：</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>split_docs<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"切分后的字符数（可以用来大致评估 token 数）：</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>page_content<span class="token punctuation">)</span> <span class="token keyword">for</span> doc <span class="token keyword">in</span> split_docs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="文档词向量化"><a class="anchor" href="#文档词向量化">#</a> 文档词向量化</h3><blockquote><p>Embedding 词嵌入，上学期讲过了，这里使用的是训练好的词嵌入模型，也就是厂家提供的 Embedding 模型。</p><p>如果没学过，可以简单理解为用向量对词语进行语义表示。</p></blockquote><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> find_dotenv<span class="token punctuation">,</span> load_dotenv</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 定义 Embeddings</span></pre></td></tr><tr><td data-num="7"></td><td><pre>embedding <span class="token operator">=</span> QianfanEmbeddingsEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"Embedding-V1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    chunk_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>query1 <span class="token operator">=</span> <span class="token string">"机器学习"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>query2 <span class="token operator">=</span> <span class="token string">"强化学习"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>query3 <span class="token operator">=</span> <span class="token string">"大语言模型"</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 通过对应的 embedding 类生成 query 的 embedding。</span></pre></td></tr><tr><td data-num="19"></td><td><pre>emb1 <span class="token operator">=</span> embedding<span class="token punctuation">.</span>embed_query<span class="token punctuation">(</span>query1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>emb2 <span class="token operator">=</span> embedding<span class="token punctuation">.</span>embed_query<span class="token punctuation">(</span>query2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>emb3 <span class="token operator">=</span> embedding<span class="token punctuation">.</span>embed_query<span class="token punctuation">(</span>query3<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 将返回结果转成 numpy 的格式，便于后续计算</span></pre></td></tr><tr><td data-num="24"></td><td><pre>emb1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>emb1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>emb2 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>emb2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>emb3 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>emb3<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>query1<span class="token punctuation">&#125;</span></span><span class="token string"> 生成的为长度 </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>emb1<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> 的 embedding , 其前 30 个值为： </span><span class="token interpolation"><span class="token punctuation">&#123;</span>emb1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">30]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>我们已经生成了对应的向量，我们如何度量文档和问题的相关性呢？</p><p>这里提供两种常用的方法：</p><ul><li>计算两个向量之间的点积。</li><li>计算两个向量之间的余弦相似度。</li></ul><pre><code>print(f&quot;&#123;query1&#125; 和 &#123;query2&#125; 向量之间的点积为：&#123;np.dot(emb1, emb2)&#125;&quot;)
print(f&quot;&#123;query1&#125; 和 &#123;query3&#125; 向量之间的点积为：&#123;np.dot(emb1, emb3)&#125;&quot;)
print(f&quot;&#123;query2&#125; 和 &#123;query3&#125; 向量之间的点积为：&#123;np.dot(emb2, emb3)&#125;&quot;)
</code></pre><p>余弦相似度计算公式：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mo fence="true">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>×</mo><msub><mi>y</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mrow><mo fence="true">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mn>2</mn></msup><mo>×</mo><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mrow><mo fence="true">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mn>2</mn></msup></mrow></msqrt></mrow></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\cos (\theta)=\frac{\sum_{i=1}^n\left(x_i \times y_i\right)}{\sqrt{\sum_{i=1}^n\left(x_i\right)^2 \times \sqrt{\sum_{i=1}^n\left(y_i\right)^2}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.02778em">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:3.824002em;vertical-align:-2.33em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.494002em"><span style="top:-2.11em"><span class="pstrut" style="height:3.677149em"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.677149em"><span class="svg-align" style="top:-4.4em"><span class="pstrut" style="height:4.4em"></span><span class="mord" style="padding-left:1em"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.804292em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.954008em"><span style="top:-3.2029em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3121490000000002em"><span class="svg-align" style="top:-3.8em"><span class="pstrut" style="height:3.8em"></span><span class="mord" style="padding-left:1em"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.804292em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.954008em"><span style="top:-3.2029em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2721489999999998em"><span class="pstrut" style="height:3.8em"></span><span class="hide-tail" style="min-width:1.02em;height:1.8800000000000001em"><svg width="400em" height="1.8800000000000001em" viewBox="0 0 400000 1944" preserveAspectRatio="xMinYMin slice"><path d="M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.527851em"><span></span></span></span></span></span></span></span><span style="top:-3.6371490000000004em"><span class="pstrut" style="height:4.4em"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em"><svg width="400em" height="2.48em" viewBox="0 0 400000 2592" preserveAspectRatio="xMinYMin slice"><path d="M424,2478
c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514
c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20
s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121
s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081
l0 -0c4,-6.7,10,-10,18,-10 H400000
v40H1014.6
s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185
c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2z M1001 80
h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.762851em"><span></span></span></span></span></span></span></span><span style="top:-3.907149em"><span class="pstrut" style="height:3.677149em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-4.366859em"><span class="pstrut" style="height:3.677149em"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.804292em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29971000000000003em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner"><span class="mopen delimcenter" style="top:0">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.33em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>query1<span class="token punctuation">&#125;</span></span><span class="token string"> 和 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>query2<span class="token punctuation">&#125;</span></span><span class="token string"> 向量之间的余弦相似度为：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>cosine_similarity<span class="token punctuation">(</span>emb1<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> emb2<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>query1<span class="token punctuation">&#125;</span></span><span class="token string"> 和 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>query3<span class="token punctuation">&#125;</span></span><span class="token string"> 向量之间的余弦相似度为：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>cosine_similarity<span class="token punctuation">(</span>emb1<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> emb3<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>query2<span class="token punctuation">&#125;</span></span><span class="token string"> 和 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>query3<span class="token punctuation">&#125;</span></span><span class="token string"> 向量之间的余弦相似度为：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>cosine_similarity<span class="token punctuation">(</span>emb2<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> emb3<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="向量数据库使用"><a class="anchor" href="#向量数据库使用">#</a> 向量数据库使用</h2><p>选择 Chroma 是因为它轻量级且数据存储在内存中，这使得它非常容易启动和开始使用。</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 加载 PDF</span></pre></td></tr><tr><td data-num="4"></td><td><pre>loaders_chinese <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    PyMuPDFLoader<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span>  <span class="token comment"># 南瓜书</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment"># 大家可以自行加入其他文件</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>docs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">for</span> loader <span class="token keyword">in</span> loaders_chinese<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    docs<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 切分文档</span></pre></td></tr><tr><td data-num="12"></td><td><pre>text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>chunk_size<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> chunk_overlap<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>split_docs <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>split_documents<span class="token punctuation">(</span>docs<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 定义 Embeddings</span></pre></td></tr><tr><td data-num="16"></td><td><pre>embedding <span class="token operator">=</span> QianfanEmbeddingsEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"Embedding-V1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    chunk_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="构建-chroma-向量库"><a class="anchor" href="#构建-chroma-向量库">#</a> 构建 Chroma 向量库</h2><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>persist_directory <span class="token operator">=</span> <span class="token string">'./chroma'</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>vectordb <span class="token operator">=</span> Chroma<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    documents<span class="token operator">=</span>split_docs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment"># 为了速度，只选择了前 100 个切分的 doc 进行生成。</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    embedding<span class="token operator">=</span>embedding<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    persist_directory<span class="token operator">=</span>persist_directory  <span class="token comment"># 允许我们将 persist_directory 目录保存到磁盘上</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 保存</span></pre></td></tr><tr><td data-num="10"></td><td><pre>vectordb<span class="token punctuation">.</span>persist<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>根据持久化文件夹，直接载入一个已有的数据库</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 直接载入</span></pre></td></tr><tr><td data-num="2"></td><td><pre>vectordb <span class="token operator">=</span> Chroma<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    persist_directory<span class="token operator">=</span>persist_directory<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    embedding_function<span class="token operator">=</span>embedding</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"向量库中存储的数量：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>vectordb<span class="token punctuation">.</span>_collection<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="加载"><a class="anchor" href="#加载">#</a> 加载</h3><p>加载多个文件的方式：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> PyMuPDFLoader<span class="token punctuation">,</span> UnstructuredMarkdownLoader</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores<span class="token punctuation">.</span>chroma <span class="token keyword">import</span> Chroma</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># pdf</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 加载 PDF</span></pre></td></tr><tr><td data-num="10"></td><td><pre>loaders <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    PyMuPDFLoader<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span>  <span class="token comment"># 机器学习，</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre>docs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">for</span> loader <span class="token keyword">in</span> loaders<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    docs<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># md</span></pre></td></tr><tr><td data-num="18"></td><td><pre>folder_path <span class="token operator">=</span> <span class="token string">"path"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>folder_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>loaders <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">for</span> one_file <span class="token keyword">in</span> files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    loader <span class="token operator">=</span> UnstructuredMarkdownLoader<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder_path<span class="token punctuation">,</span> one_file<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    loaders<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loader<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">for</span> loader <span class="token keyword">in</span> loaders<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    docs<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="检索式问答"><a class="anchor" href="#检索式问答">#</a> 检索式问答</h2><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> RetrievalQA</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores<span class="token punctuation">.</span>chroma <span class="token keyword">import</span> Chroma</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 声明一个检索式问答链</span></pre></td></tr><tr><td data-num="8"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>llm <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"ERNIE-Bot"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>embedding <span class="token operator">=</span> QianfanEmbeddingsEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"Embedding-V1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    chunk_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 假设已经在以下路径持久化</span></pre></td></tr><tr><td data-num="21"></td><td><pre>persist_directory <span class="token operator">=</span> <span class="token string">'path'</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 直接载入</span></pre></td></tr><tr><td data-num="24"></td><td><pre>vectordb <span class="token operator">=</span> Chroma<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    persist_directory<span class="token operator">=</span>persist_directory<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    embedding_function<span class="token operator">=</span>embedding</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>qa_chain <span class="token operator">=</span> RetrievalQA<span class="token punctuation">.</span>from_chain_type<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    llm<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    retriever<span class="token operator">=</span>vectordb<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># 可以以该方式进行检索问答</span></pre></td></tr><tr><td data-num="35"></td><td><pre>question <span class="token operator">=</span> <span class="token string">"本知识库主要包含什么内容"</span></pre></td></tr><tr><td data-num="36"></td><td><pre>result <span class="token operator">=</span> qa_chain<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"query"</span><span class="token punctuation">:</span> question<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"大语言模型的回答为：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="加入prompt"><a class="anchor" href="#加入prompt">#</a> 加入 Prompt</h3><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> RetrievalQA</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores<span class="token punctuation">.</span>chroma <span class="token keyword">import</span> Chroma</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 声明一个检索式问答链</span></pre></td></tr><tr><td data-num="8"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>llm <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"ERNIE-Bot"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>embedding <span class="token operator">=</span> QianfanEmbeddingsEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"Embedding-V1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    chunk_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># Build prompt</span></pre></td></tr><tr><td data-num="22"></td><td><pre>template <span class="token operator">=</span> <span class="token triple-quoted-string string">"""使用以下上下文片段来回答最后的问题。如果你不知道答案，只需说不知道，不要试图编造答案。答案最多使用三个句子。尽量简明扼要地回答。在回答的最后一定要说"感谢您的提问！"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>&#123;context&#125;</pre></td></tr><tr><td data-num="24"></td><td><pre>问题：&#123;question&#125;</pre></td></tr><tr><td data-num="25"></td><td><pre>有用的回答："""</pre></td></tr><tr><td data-num="26"></td><td><pre>QA_CHAIN_PROMPT <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span>template<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># 假设已经在以下路径持久化</span></pre></td></tr><tr><td data-num="28"></td><td><pre>persist_directory <span class="token operator">=</span> <span class="token string">'path'</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># 直接载入</span></pre></td></tr><tr><td data-num="31"></td><td><pre>vectordb <span class="token operator">=</span> Chroma<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    persist_directory<span class="token operator">=</span>persist_directory<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    embedding_function<span class="token operator">=</span>embedding</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># Run chain</span></pre></td></tr><tr><td data-num="37"></td><td><pre>qa_chain <span class="token operator">=</span> RetrievalQA<span class="token punctuation">.</span>from_chain_type<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    llm<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    retriever<span class="token operator">=</span>vectordb<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    return_source_documents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    chain_type_kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"prompt"</span><span class="token punctuation">:</span> QA_CHAIN_PROMPT<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>question <span class="token operator">=</span> <span class="token string">" 2025 年大语言模型效果最好的是哪个模型"</span></pre></td></tr><tr><td data-num="45"></td><td><pre>result <span class="token operator">=</span> qa_chain<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"query"</span><span class="token punctuation">:</span> question<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"LLM 对问题的回答：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="记忆功能"><a class="anchor" href="#记忆功能">#</a> 记忆功能</h2><p>有多种数据类型，以下是其中两种</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>memory <span class="token keyword">import</span> ConversationBufferMemory</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>memory <span class="token operator">=</span> ConversationBufferMemory<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    memory_key<span class="token operator">=</span><span class="token string">"chat_history"</span><span class="token punctuation">,</span>  <span class="token comment"># 与 prompt 的输入变量保持一致。</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    return_messages<span class="token operator">=</span><span class="token boolean">True</span>  <span class="token comment"># 将以消息列表的形式返回聊天记录，而不是单个字符串</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>memory <span class="token keyword">import</span> ChatMessageHistory</pre></td></tr><tr><td data-num="2"></td><td><pre>history <span class="token operator">=</span> ChatMessageHistory<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>history<span class="token punctuation">.</span>add_user_message<span class="token punctuation">(</span><span class="token string">"hi!"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>history<span class="token punctuation">.</span>add_ai_message<span class="token punctuation">(</span><span class="token string">"whats up?"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token triple-quoted-string string">"""</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Human: hi!</pre></td></tr><tr><td data-num="8"></td><td><pre>AI: whats up?</pre></td></tr><tr><td data-num="9"></td><td><pre>"""</pre></td></tr></table></figure><h3 id="对话检索链"><a class="anchor" href="#对话检索链">#</a> 对话检索链</h3><p><img data-src="https://datawhalechina.github.io/llm-universe/figures/Modular_components.png" alt="img"></p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>vectorstores <span class="token keyword">import</span> Chroma</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>llm <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"ERNIE-Bot"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>embedding <span class="token operator">=</span> QianfanEmbeddingsEndpoint<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    streaming<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    model<span class="token operator">=</span><span class="token string">"Embedding-V1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    chunk_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 向量数据库持久化路径</span></pre></td></tr><tr><td data-num="21"></td><td><pre>persist_directory <span class="token operator">=</span> <span class="token string">'path'</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 加载数据库</span></pre></td></tr><tr><td data-num="23"></td><td><pre>vectordb <span class="token operator">=</span> Chroma<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    persist_directory<span class="token operator">=</span>persist_directory<span class="token punctuation">,</span>  <span class="token comment"># 允许我们将 persist_directory 目录保存到磁盘上</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    embedding_function<span class="token operator">=</span>embedding</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>memory <span class="token keyword">import</span> ConversationBufferMemory</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>memory <span class="token operator">=</span> ConversationBufferMemory<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    memory_key<span class="token operator">=</span><span class="token string">"chat_history"</span><span class="token punctuation">,</span>  <span class="token comment"># 与 prompt 的输入变量保持一致。</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    return_messages<span class="token operator">=</span><span class="token boolean">True</span>  <span class="token comment"># 将以消息列表的形式返回聊天记录，而不是单个字符串</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> ConversationalRetrievalChain</pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>retriever <span class="token operator">=</span> vectordb<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>qa <span class="token operator">=</span> ConversationalRetrievalChain<span class="token punctuation">.</span>from_llm<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    llm<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    retriever<span class="token operator">=</span>retriever<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    memory<span class="token operator">=</span>memory</pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>question <span class="token operator">=</span> <span class="token string">"我可以学习到关于强化学习的知识吗？"</span></pre></td></tr><tr><td data-num="45"></td><td><pre>result <span class="token operator">=</span> qa<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"question"</span><span class="token punctuation">:</span> question<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">'answer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="其他"><a class="anchor" href="#其他">#</a> 其他</h1></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-03-25 21:07:14" itemprop="dateModified" datetime="2024-03-25T21:07:14+08:00">2024-03-25</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="镜玄 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="镜玄 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="镜玄 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>镜玄 <i class="ic i-at"><em>@</em></i>镜玄的博客</li><li class="link"><strong>本文链接：</strong> <a href="https://withoutabc.github.io/2024/03/15/LLM-Langchain%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/" title="LLM&amp;Langchain————大模型应用开发">https://withoutabc.github.io/2024/03/15/LLM-Langchain————大模型应用开发/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/02/19/%E5%B7%A5%E5%85%B7%E7%AE%B1/%E8%B0%83%E7%94%A8api%E6%8E%A5%E5%8F%A3%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87%E9%93%BE%E6%8E%A5/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;07&#x2F;28&#x2F;q5ZYmcyNWrSgCtf.jpg" title="调用api接口快速生成图片链接"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 工具箱</span><h3>调用api接口快速生成图片链接</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">大模型简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%A4%A7%E6%A8%A1%E5%9E%8Bapi%E7%99%BE%E5%BA%A6%E6%96%87%E5%BF%83%E4%B8%BA%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text">调用大模型 API（百度文心为例）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#langchain%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.</span> <span class="toc-text">Langchain 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#langchain%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.1.</span> <span class="toc-text">Langchain 核心组件详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA"><span class="toc-number">3.1.1.</span> <span class="toc-text">模型输入 &#x2F; 输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.1.2.</span> <span class="toc-text">数据连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE"><span class="toc-number">3.1.3.</span> <span class="toc-text">链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%B0%E5%BF%86"><span class="toc-number">3.1.4.</span> <span class="toc-text">记忆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86"><span class="toc-number">3.1.5.</span> <span class="toc-text">代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83"><span class="toc-number">3.1.6.</span> <span class="toc-text">回调</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.</span> <span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">环境变量配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E9%97%AE"><span class="toc-number">4.2.</span> <span class="toc-text">提问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE-2"><span class="toc-number">4.3.</span> <span class="toc-text">链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AA%E6%80%A7%E5%8C%96template"><span class="toc-number">4.4.</span> <span class="toc-text">个性化 Template</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">大模型开发流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%BA%93%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">知识库文档处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD"><span class="toc-number">5.1.1.</span> <span class="toc-text">文档加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pdf%E6%96%87%E6%A1%A3"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">PDF 文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#md%E6%96%87%E6%A1%A3"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">MD 文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%88%86%E5%89%B2"><span class="toc-number">5.1.2.</span> <span class="toc-text">文档分割</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E8%AF%8D%E5%90%91%E9%87%8F%E5%8C%96"><span class="toc-number">5.1.3.</span> <span class="toc-text">文档词向量化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">向量数据库使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA-chroma-%E5%90%91%E9%87%8F%E5%BA%93"><span class="toc-number">5.3.</span> <span class="toc-text">构建 Chroma 向量库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD"><span class="toc-number">5.3.1.</span> <span class="toc-text">加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E5%BC%8F%E9%97%AE%E7%AD%94"><span class="toc-number">5.4.</span> <span class="toc-text">检索式问答</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5prompt"><span class="toc-number">5.4.1.</span> <span class="toc-text">加入 Prompt</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BF%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.5.</span> <span class="toc-text">记忆功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%AF%9D%E6%A3%80%E7%B4%A2%E9%93%BE"><span class="toc-number">5.5.1.</span> <span class="toc-text">对话检索链</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">6.</span> <span class="toc-text">其他</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="镜玄" data-src="/images/avatar.jpg"><p class="name" itemprop="name">镜玄</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">16</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">5</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">14</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dpdGhvdXRhYmM=" title="https:&#x2F;&#x2F;github.com&#x2F;withoutabc"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOmZ3NTVmZnd3QG91dGxvb2suY29t" title="mailto:fw55ffww@outlook.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-magic"></i>链环</a><ul class="submenu"><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>朋友</a></li><li class="item"><a href="/websites/" rel="section"><i class="ic i-link-circle"></i>网址</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E8%BF%90%E7%BB%B4/" title="分类于 运维">运维</a></div><span><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/NFS%E9%85%8D%E7%BD%AE/" title="NFS配置">NFS配置</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a></div><span><a href="/2023/12/17/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%8F%89%E6%A0%91/" title="二叉树">二叉树</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/13/%E5%90%8E%E7%AB%AF/viper/" title="viper">viper</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/07/%E5%90%8E%E7%AB%AF/Traefik%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%BD%BF%E7%94%A8/" title="Traefik部署及使用">Traefik部署及使用</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/15/LLM-Langchain%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/" title="LLM&amp;Langchain————大模型应用开发">LLM&Langchain————大模型应用开发</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2023/12/18/%E5%90%8E%E7%AB%AF/Minio%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%BD%BF%E7%94%A8/" title="Minio部署及使用">Minio部署及使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/12/%E5%90%8E%E7%AB%AF/Rabbitmq/" title="Rabbitmq">Rabbitmq</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/golang%E5%9F%BA%E7%A1%80/" title="分类于 golang基础">golang基础</a></div><span><a href="/2024/02/06/golang%E5%9F%BA%E7%A1%80/container%E5%8C%85/" title="container包">container包</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/13/%E5%90%8E%E7%AB%AF/Sentinel/" title="Sentinel">Sentinel</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%BF%90%E7%BB%B4/" title="分类于 运维">运维</a></div><span><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/Kubernetes%E5%9F%BA%E7%A1%80/" title="Kubernetes基础">Kubernetes基础</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">镜玄 @ 寄寄菜鸟试飞点</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">160k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2:25</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/03/15/LLM-Langchain————大模型应用开发/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->