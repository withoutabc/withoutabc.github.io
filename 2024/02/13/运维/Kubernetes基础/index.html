<!-- build time:Wed Mar 06 2024 16:00:21 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="镜玄的博客" href="https://withoutabc.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="镜玄的博客" href="https://withoutabc.github.io/atom.xml"><link rel="alternate" type="application/json" title="镜玄的博客" href="https://withoutabc.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="k8s"><link rel="canonical" href="https://withoutabc.github.io/2024/02/13/%E8%BF%90%E7%BB%B4/Kubernetes%E5%9F%BA%E7%A1%80/"><title>Kubernetes基础 - 运维 | 寄寄菜鸟试飞点 = 镜玄的博客 = 某个INTJ的领域</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Kubernetes基础</h1><div class="meta"><span class="item" title="创建时间：2024-02-13 00:38:55"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-02-13T00:38:55+08:00">2024-02-13</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>29k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>26 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">寄寄菜鸟试飞点</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/07/26/r2lgYQCFXzUINaV.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/24/g6rcNJdPIZYK4OR.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/26/rUfT36ZxmGXzLDv.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/26/CreEwmQgVBqfYdN.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/26/vJ6XgDta1xUhRNZ.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/07/26/KmSLPZbsRvnw89F.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="item" rel="index" title="分类于 运维"><span itemprop="name">运维</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://withoutabc.github.io/2024/02/13/%E8%BF%90%E7%BB%B4/Kubernetes%E5%9F%BA%E7%A1%80/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="镜玄"><meta itemprop="description" content="某个INTJ的领域, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="镜玄的博客"></span><div class="body md" itemprop="articleBody"><h1 id="pod-收纳仓"><a class="anchor" href="#pod-收纳仓">#</a> Pod-&quot;收纳仓&quot;</h1><ul><li>从 Pod 开始，扩展出了 Kubernetes 里的一些重要 API 对象</li></ul><p><img data-src="https://s2.loli.net/2024/02/17/41zp8kE6UmAoscu.png" alt="pod.png"></p><ul><li><p><code>apiVersion</code> 和 <code>kind</code> 这两个字段很简单，对于 Pod 来说分别是固定的值 <code>v1</code> 和 <code>Pod</code> ，而一般来说，“metadata” 里应该有 <code>name</code> 和 <code>labels</code> 这两个字段。</p></li><li><p>但在 Kubernetes 里，Pod 必须要有一个名字。这也是 Kubernetes 里所有资源对象的一个约定。 一般加上 <code>pod</code> 后缀</p></li><li><p><code>name</code> 只是一个基本的标识，信息有限，所以 <code>labels</code> 字段就派上了用处。它可以添加任意数量的 Key-Value，给 Pod “贴” 上归类的标签，结合 <code>name</code> 就更方便识别和管理了。</p></li></ul><p>根据运行环境， <code>env=dev/test/prod</code></p><p>根据所在的数据中心，使用标签 <code>region: north/south</code></p><p>根据应用在系统中的层次，使用 <code>tier=front/middle/back</code></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> busy<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">owner</span><span class="token punctuation">:</span> chrono</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">env</span><span class="token punctuation">:</span> demo</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">region</span><span class="token punctuation">:</span> north</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">tier</span><span class="token punctuation">:</span> back</pre></td></tr></table></figure><h2 id="container"><a class="anchor" href="#container">#</a> container</h2><p>“containers” 是一个数组，里面的每一个元素又是一个 container 对象，也就是容器。</p><ul><li>container 对象也必须要有一个 <code>name</code> 表示名字，然后当然还要有一个 <code>image</code> 字段来说明它使用的镜像，这两个字段是必须要有的 。</li></ul><h3 id="字段"><a class="anchor" href="#字段">#</a> 字段</h3><ul><li><p><strong>ports</strong>：列出容器对外暴露的端口，和 Docker 的 <code>-p</code> 参数有点像。</p></li><li><p><strong>imagePullPolicy</strong>：指定镜像的拉取策略，可以是 <code>Always</code> / <code>Never</code> / <code>IfNotPresent</code> ，一般默认是 <code>IfNotPresent</code> ，也就是说只有本地不存在才会远程拉取镜像，可以减少网络消耗。</p></li><li><p><strong>env</strong>：定义 Pod 的环境变量，和 Dockerfile 里的 <code>ENV</code> 指令有点类似，但它是运行时指定的，更加灵活可配置。</p></li><li><p><strong>command</strong>：定义容器启动时要执行的命令，相当于 Dockerfile 里的 <code>ENTRYPOINT</code> 指令。</p></li><li><p><strong>args</strong>：它是 command 运行时的参数，相当于 Dockerfile 里的 <code>CMD</code> 指令，这两个命令和 Docker 的含义不同，要特别注意。</p></li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> busy</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">env</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> os</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"ubuntu"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> debug</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"on"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> /bin/echo</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">args</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"$(os), $(debug)"</span></pre></td></tr></table></figure><h2 id="复制和执行命令"><a class="anchor" href="#复制和执行命令">#</a> 复制和执行命令</h2><p>比如我有一个 “a.txt” 文件，那么就可以使用 <code>kubectl cp</code> 拷贝进 Pod 的 “/tmp” 目录里：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">echo</span> <span class="token string">'aaa'</span> <span class="token operator">></span> a.txt</pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl <span class="token function">cp</span> a.txt ngx-pod:/tmp</pre></td></tr></table></figure><p>不过 <code>kubectl exec</code> 的命令格式与 Docker 有一点小差异，需要在 Pod 后面加上 <code>--</code> ，把 kubectl 的命令与 Shell 命令分隔开：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> ngx-pod -- <span class="token function">sh</span></pre></td></tr></table></figure><h1 id="job-临时任务"><a class="anchor" href="#job-临时任务">#</a> Job-&quot;临时任务&quot;</h1><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Job</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>job</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure</pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>job</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/echo"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><ul><li><code>spec</code> 字段里，多了一个 <code>template</code> 字段，然后又是一个 <code>spec</code></li><li><code>template</code> 字段定义了一个 “<strong>应用模板</strong>” ，里面嵌入了一个 Pod，这样 Job 就可以从这个模板来创建出 Pod。</li></ul><p><img data-src="https://s2.loli.net/2024/02/17/QWlv94pOTYCabKH.png" alt="job.jpg"></p><ul><li><p>这里的 Pod 工作非常简单，在 <code>containers</code> 里写好名字和镜像， <code>command</code> 执行 <code>/bin/echo</code> ，输出 “hello world”。</p></li><li><p>不过，因为 Job 业务的特殊性，所以我们还要在 <code>spec</code> 里多加一个字段 <code>restartPolicy</code> ，确定 Pod 运行失败时的策略， <code>OnFailure</code> 是失败原地重启容器，而 <code>Never</code> 则是不重启容器，让 Job 去重新调度生成一个新的 Pod。</p></li></ul><p>再创建一个 Job 对象，名字叫 “sleep-job”，它随机睡眠一段时间再退出，模拟运行时间较长的作业（比如 MapReduce）。Job 的参数设置成 15 秒超时，最多重试 2 次，总共需要运行完 4 个 Pod，但同一时刻最多并发 2 个 Pod：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Job</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep<span class="token punctuation">-</span>job</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span> <span class="token comment"># 设置 Pod 运行的超时时间</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 设置 Pod 的失败重试次数</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">4</span> <span class="token comment"># Job 完成需要运行多少个 Pod，默认是 1 个</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 它与 completions 相关，表示允许并发运行的 Pod 数量，避免过多占用资源。</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 这 4 个字段并不在 template 字段下，而是在 spec 字段下，所以它们是属于 Job 级别的，用来控制模板里的 Pod 对象。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure <span class="token comment"># 失败原地重启容器</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>job</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token punctuation">-</span> sh</pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c</pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token punctuation">-</span> sleep $(($RANDOM % 10 + 1)) <span class="token important">&amp;&amp;</span> echo done</pre></td></tr></table></figure><h1 id="cronjob-定时任务"><a class="anchor" href="#cronjob-定时任务">#</a> CronJob-&quot;定时任务&quot;</h1><ul><li>简写 <code>cj</code></li><li><code>CronJob</code> 需要定时运行，所以我们在命令行里还需要指定参数 <code>--schedule</code></li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>cj</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">'*/1 * * * *'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure</pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>cj</pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/echo"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>连续三个 spec 嵌套：</p><ul><li>第一个 <code>spec</code> 是 CronJob 自己的对象规格声明</li><li>第二个 <code>spec</code> 从属于 “jobTemplate”，它定义了一个 Job 对象。</li><li>第三个 <code>spec</code> 从属于 “template”，它定义了 Job 里运行的 Pod。</li></ul><p><img data-src="https://s2.loli.net/2024/02/17/vQ2K7jHtxh4WzBy.png" alt="cj.png"></p><ul><li>除了定义 Job 对象的 “<strong>jobTemplate</strong>” 字段之外，CronJob 还有一个新字段就是 “<strong>schedule</strong>”，用来定义任务周期运行的规则。</li></ul><h1 id="configmapsecret"><a class="anchor" href="#configmapsecret">#</a> ConfigMap/Secret</h1><p>数据安全的角度来看可以分成两类：</p><ul><li><p>一类是明文配置，也就是不保密，可以任意查询修改，比如服务端口、运行参数、文件路径等等。</p></li><li><p>另一类则是机密配置，由于涉及敏感信息需要保密，不能随便查看，比如密码、密钥、证书等等。</p></li></ul><p><strong>ConfigMap</strong> 用来保存明文配置，<strong>Secret</strong> 用来保存秘密配置 。</p><h2 id="configmap"><a class="anchor" href="#configmap">#</a> ConfigMap</h2><h3 id="样板"><a class="anchor" href="#样板">#</a> 样板</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> info</pre></td></tr></table></figure><ul><li><p>没有 <code>spec</code> 字段</p></li><li><p>存储配置数据，不是容器，是静态的字符串</p></li></ul><h3 id="data-字段"><a class="anchor" href="#data-字段">#</a> data 字段</h3><p>生成带有 “data” 字段的 YAML 样板：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl create cm info --from-literal<span class="token operator">=</span>k<span class="token operator">=</span>v <span class="token variable">$out</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> info</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token string">'10'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">debug</span><span class="token punctuation">:</span> <span class="token string">'on'</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">'/etc/systemd'</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">greeting</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    say hello to kubernetes.</pre></td></tr></table></figure><p><strong>执行</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl apply <span class="token parameter variable">-f</span> cm.yml</pre></td></tr></table></figure><p>用 <code>kubectl get</code> 、 <code>kubectl describe</code> 来查看 ConfigMap 的状态：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl get cm</pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl describe cm info</pre></td></tr></table></figure><h2 id="secret"><a class="anchor" href="#secret">#</a> Secret</h2><p>它和 ConfigMap 的结构和用法很类似，不过在 Kubernetes 里 Secret 对象又细分出很多类，比如：</p><ul><li><p>访问私有镜像仓库的认证信息</p></li><li><p>身份识别的凭证信息</p></li><li><p>HTTPS 通信的证书和私钥</p></li><li><p>一般的机密信息（格式由用户自行解释）</p></li></ul><h3 id="样板-2"><a class="anchor" href="#样板-2">#</a> 样板</h3><p>创建 YAML 样板：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl create secret generic user --from-literal<span class="token operator">=</span>name<span class="token operator">=</span>root <span class="token variable">$out</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> user</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> cm9vdA==</pre></td></tr></table></figure><ul><li>name 后面不是 root，而是乱码，实际上经过了 base64 加密。</li></ul><p>也可以自己加密，写成 yaml 文件：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"123456"</span> <span class="token operator">|</span> base64</pre></td></tr><tr><td data-num="2"></td><td><pre>MTIzNDU2</pre></td></tr></table></figure><ul><li><code>-n</code> 用于去掉隐藏的换行符</li></ul><p>创建和查看：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl apply  <span class="token parameter variable">-f</span> secret.yml</pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl get secret</pre></td></tr><tr><td data-num="3"></td><td><pre>kubectl describe secret user</pre></td></tr></table></figure><h2 id="如何使用"><a class="anchor" href="#如何使用">#</a> 如何使用</h2><p>因为 ConfigMap 和 Secret 只是一些存储在 etcd 里的字符串，所以如果想要在运行时产生效果，就必须要以某种方式 “注入” 到 Pod 里，让应用去读取。</p><h3 id="环境变量"><a class="anchor" href="#环境变量">#</a> 环境变量</h3><p><code>containers</code> 里有一个 <code>env</code> , 除了可以使用简单的 <code>value</code> , 还可以使用 <code>valueFrom</code></p><ul><li><p>“<strong>valueFrom</strong>” 字段指定了环境变量值的来源，可以是 “<strong>configMapKeyRef</strong>” 或者 “<strong>secretKeyRef</strong>”，然后你要再进一步指定应用的 <strong>ConfigMap/Secret</strong> 的 “<strong>name</strong>” 和它里面的 “<strong>key</strong>”。</p></li><li><p>要当心的是这个 “name” 字段是 API 对象的名字，而不是 Key-Value 的名字。</p></li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> COUNT</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> info</pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token key atrule">key</span><span class="token punctuation">:</span> count</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GREETING</pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> info</pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token key atrule">key</span><span class="token punctuation">:</span> greeting</pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> USERNAME</pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> user</pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token key atrule">key</span><span class="token punctuation">:</span> name</pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PASSWORD</pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> user</pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token key atrule">key</span><span class="token punctuation">:</span> pwd</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> busy</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span><span class="token punctuation">,</span> <span class="token string">"300"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/vnkFKwBHqEN3iZD.png" alt="cm.png"></p><p>弄清楚了环境变量的注入方式之后，让我们用 <code>kubectl apply</code> 创建 Pod，再用 <code>kubectl exec</code> 进入 Pod，验证环境变量是否生效：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl apply <span class="token parameter variable">-f</span> env-pod.yml</pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl get pod</pre></td></tr><tr><td data-num="3"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> env-pod -- <span class="token function">sh</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token builtin class-name">echo</span> <span class="token variable">$COUNT</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">10</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token builtin class-name">echo</span> <span class="token variable">$GREETING</span></pre></td></tr><tr><td data-num="8"></td><td><pre>say hello to kubernetes</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token builtin class-name">echo</span> <span class="token variable">$USERNAME</span> <span class="token variable">$PASSWORD</span></pre></td></tr><tr><td data-num="10"></td><td><pre>root <span class="token number">123456</span></pre></td></tr></table></figure><h3 id="volume-存储卷"><a class="anchor" href="#volume-存储卷">#</a> Volume - 存储卷</h3><p>如果把 Pod 理解成是一个虚拟机，那么 Volume 就相当于是虚拟机里的磁盘。 我们可以为 Pod“挂载（mount）” 多个 Volume，里面存放供 Pod 访问的数据 。</p><ul><li>只需要在 <code>spec</code> 里增加一个 <code>volumes</code> 字段</li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> vol<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">configMap</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> info</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sec<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">secret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> user</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp/cm<span class="token punctuation">-</span>items <span class="token comment"># 指定挂载路径</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>vol <span class="token comment"># 指定 volume 名称</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp/sec<span class="token punctuation">-</span>items</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> sec<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> busy</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span><span class="token punctuation">,</span> <span class="token string">"300"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/kw9MJHrBy3AVe6q.png" alt=""></p><p>进去看看：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl apply <span class="token parameter variable">-f</span> vol-pod.yml</pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl get pod</pre></td></tr><tr><td data-num="3"></td><td><pre>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> vol-pod -- <span class="token function">sh</span></pre></td></tr><tr><td data-num="4"></td><td><pre>/ <span class="token comment"># ls /tmp/cm-items/</span></pre></td></tr><tr><td data-num="5"></td><td><pre>count debug greeting path</pre></td></tr><tr><td data-num="6"></td><td><pre>/ <span class="token comment"># cat /tmp/cm-items/greeting</span></pre></td></tr><tr><td data-num="7"></td><td><pre>say hello to kubernetes.</pre></td></tr></table></figure><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2><p>ConfigMap 和 Secret 对存储数据的大小没有限制，但小数据用环境变量比较适合，大数据应该用存储卷，可根据具体场景灵活应用。</p><h1 id="deployment"><a class="anchor" href="#deployment">#</a> Deployment</h1><p>能够创建任意多个的 Pod 实例，并且维护这些 Pod 的正常运行，保证应用始终处于可用状态。</p><h2 id="样板-3"><a class="anchor" href="#样板-3">#</a> 样板</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="7"></td><td><pre>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="13"></td><td><pre>      </pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr></table></figure><ul><li>它的 “spec” 部分多了 <code>replicas</code> 、 <code>selector</code> 这两个新字段</li></ul><h2 id="字段-2"><a class="anchor" href="#字段-2">#</a> 字段</h2><h3 id="replicas"><a class="anchor" href="#replicas">#</a> replicas</h3><p>万一有 Pod 发生意外消失了，数量不满足 “期望状态”，它就会通过 apiserver、scheduler 等核心组件去选择新的节点，创建出新的 Pod，直至数量与 “期望状态” 一致。</p><h3 id="selector"><a class="anchor" href="#selector">#</a> selector</h3><p>通过标签这种设计，Kubernetes 就解除了 Deployment 和模板里 Pod 的强绑定，把组合关系变成了 “弱引用”。</p><p><img data-src="https://s2.loli.net/2024/02/17/FUoZQCGB47LvMwS.png" alt="dep.png"></p><h3 id="应用伸缩"><a class="anchor" href="#应用伸缩">#</a> 应用伸缩</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">5</span> deploy ngx-dep</pre></td></tr></table></figure><h1 id="daemonset"><a class="anchor" href="#daemonset">#</a> DaemonSet</h1><p>但是有一些业务比较特殊，它们不是完全独立于系统运行的，而是与主机存在 “绑定” 关系，必须要依附于节点才能产生价值，比如说：</p><ul><li><p>网络应用（如 kube-proxy），必须每个节点都运行一个 Pod，否则节点就无法加入 Kubernetes 网络。</p></li><li><p>监控应用（如 Prometheus），必须每个节点都有一个 Pod 用来监控节点的状态，实时上报信息。</p></li><li><p>日志应用（如 Fluentd），必须在每个节点上运行一个 Pod，才能够搜集容器运行时产生的日志数据。</p></li><li><p>安全应用，同样的，每个节点都要有一个 Pod 来执行安全审计、入侵检查、漏洞扫描等工作。</p></li></ul><h2 id="样板-4"><a class="anchor" href="#样板-4">#</a> 样板</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>ds</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>ds</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>ds</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>ds</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5<span class="token punctuation">-</span>alpine</pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> redis</pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></pre></td></tr></table></figure><ul><li>没有 replicas</li></ul><h2 id="污点和容忍度"><a class="anchor" href="#污点和容忍度">#</a> 污点和容忍度</h2><h3 id="查看-master-和-worker-的状态"><a class="anchor" href="#查看-master-和-worker-的状态">#</a> 查看 Master 和 Worker 的状态</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl describe <span class="token function">node</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl describe <span class="token function">node</span> master</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>Name:     master</pre></td></tr><tr><td data-num="4"></td><td><pre>Roles:    control-plane,master</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>Taints:   node-role.kubernetes.io/master:NoSchedule</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>kubectl describe <span class="token function">node</span> worker</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>Name:     worker</pre></td></tr><tr><td data-num="12"></td><td><pre>Roles:    <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="14"></td><td><pre>Taints:   <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p>Master 节点默认有一个 <code>taint</code> ，名字是 <code>node-role.kubernetes.io/master</code> ，它的效果是 <code>NoSchedule</code> ，也就是说这个污点会拒绝 Pod 调度到本节点上运行，而 Worker 节点的 <code>taint</code> 字段则是空的。</p><h2 id="怎么让-daemonset-在-master-节点或者任意其他节点上运行了"><a class="anchor" href="#怎么让-daemonset-在-master-节点或者任意其他节点上运行了">#</a> 怎么让 DaemonSet 在 Master 节点（或者任意其他节点）上运行了？</h2><h3 id="去除污点"><a class="anchor" href="#去除污点">#</a> 去除污点</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl taint <span class="token function">node</span> master node-role.kubernetes.io/master:NoSchedule-node/master untainted</pre></td></tr></table></figure><h3 id="添加-pod-字段-tolerations"><a class="anchor" href="#添加-pod-字段-tolerations">#</a> 添加 pod 字段 tolerations</h3><p>如果我们想让 DaemonSet 里的 Pod 能够在 Master 节点上运行，就要写出这样的一个 <code>tolerations</code> ，容忍节点的 <code>node-role.kubernetes.io/master:NoSchedule</code> 这个污点：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">tolerations</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists</pre></td></tr></table></figure><h3 id="添加污点"><a class="anchor" href="#添加污点">#</a> (添加污点)</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl taint <span class="token function">node</span> master node-role.kubernetes.io/master:NoSchedule</pre></td></tr></table></figure><h1 id="service"><a class="anchor" href="#service">#</a> Service</h1><p><img data-src="https://s2.loli.net/2024/02/17/QrpTktueWZ2gVcn.png" alt="service.png"></p><p><strong>虽然它可以自动创建 YAML 样板，但不是用命令</strong> <code>kubectl create</code> ，<strong>而是另外一个命令</strong> <code>kubectl expose</code> ，也许 Kubernetes 认为 “expose” 能够更好地表达 Service “暴露” 服务地址的意思吧。</p><ul><li><code>kubectl expose</code> 支持从多种对象创建服务，Pod、Deployment、DaemonSet 都可以。</li></ul><p>使用 <code>kubectl expose</code> 指令时还需要用参数 <code>--port</code> 和 <code>--target-port</code> 分别指定映射端口和容器端口，而 Service 自己的 IP 地址和后端 Pod 的 IP 地址可以自动生成 。</p><h2 id="样板-5"><a class="anchor" href="#样板-5">#</a> 样板</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="9"></td><td><pre>    </pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 外部端口</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 内部端口</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment"># 使用的协议</span></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/tAlPzc4NL6iVMFm.png" alt="service1.png"></p><h2 id="以域名的方式使用-service"><a class="anchor" href="#以域名的方式使用-service">#</a> 以域名的方式使用 service</h2><p>查看命名空间</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl get ns</pre></td></tr></table></figure><p>Service 对象的域名完全形式是 “<strong>对象。名字空间.svc.cluster.local</strong>”，但很多时候也可以省略后面的部分，直接写 “<strong>对象。名字空间</strong>” 甚至 “<strong>对象名</strong>” 就足够了，默认会使用对象所在的名字空间 。</p><h2 id="让-service-对外暴露"><a class="anchor" href="#让-service-对外暴露">#</a> 让 Service 对外暴露</h2><p>Service 对象有一个关键字段 <strong>“type”</strong>，表示 Service 是哪种类型的负载均衡。前面我们看到的用法都是对集群内部 Pod 的负载均衡，所以这个字段的值就是默认的 <strong>“ClusterIP”</strong>，Service 的静态 IP 地址只能在集群内访问。</p><p>如果我们在使用命令 <code>kubectl expose</code> 的时候加上参数 <code>--type=NodePort</code> ，或者在 YAML 里添加字段 <code>type:NodePort</code> ，那么 Service 除了会对后端的 Pod 做负载均衡之外，还会在集群里的每个节点上创建一个独立的端口，用这个端口对外提供服务，这也正是 “NodePort” 这个名字的由来。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">...</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">...</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/soa4nCl3FArhYJE.png" alt="service2.png"></p><h1 id="ingressingress-class"><a class="anchor" href="#ingressingress-class">#</a> Ingress/Ingress Class</h1><h2 id="ingress"><a class="anchor" href="#ingress">#</a> Ingress</h2><h3 id="样板-6"><a class="anchor" href="#样板-6">#</a> 样板</h3><p>两个附加参数：</p><ul><li><p><code>--class</code> ，指定 Ingress 从属的 Ingress Class 对象。</p></li><li><p><code>--rule</code> ，指定路由规则，基本形式是 “URI=Service”，也就是说是访问 HTTP 路径就转发到对应的 Service 对象，再由 Service 对象转发给后端的 Pod。</p></li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">out</span><span class="token operator">=</span><span class="token string">"--dry-run=client -o yaml"</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl create ing ngx-ing <span class="token parameter variable">--rule</span><span class="token operator">=</span><span class="token string">"ngx.test/=ngx-svc:80"</span> <span class="token parameter variable">--class</span><span class="token operator">=</span>ngx-ink <span class="token variable">$out</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>ing</pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>ink</pre></td></tr><tr><td data-num="9"></td><td><pre>  </pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> ngx.test</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">http</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">paths</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Exact <span class="token comment"># 路径的匹配方式 Exact 精确匹配 Prefix 前缀匹配</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">service</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token key atrule">port</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr></table></figure><h2 id="ingress-class"><a class="anchor" href="#ingress-class">#</a> Ingress Class</h2><h3 id="样板-7"><a class="anchor" href="#样板-7">#</a> 样板</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> IngressClass</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>ink</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">controller</span><span class="token punctuation">:</span> nginx.org/ingress<span class="token punctuation">-</span>controller</pre></td></tr></table></figure><p><code>spec</code> 里只有一个必需的字段 <code>controller</code> ，表示要使用哪个 Ingress Controller，具体的名字就要看实现文档了。</p><p>比如，如果我要用 Nginx 开发的 Ingress Controller，那么就要用名字 <code>nginx.org/ingress-controller</code></p><p><img data-src="https://s2.loli.net/2024/02/17/TWDyuRnOANkSgVz.png" alt="ingress.png"></p><h2 id="使用"><a class="anchor" href="#使用">#</a> 使用</h2><p><img data-src="https://s2.loli.net/2024/02/17/QN86ZvV49WCmcGz.png" alt="ingress0.png"></p><h1 id="wordpress-部署"><a class="anchor" href="#wordpress-部署">#</a> WordPress 部署</h1><h2 id="部署-mariadb"><a class="anchor" href="#部署-mariadb">#</a> 部署 MariaDB</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>cm</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">DATABASE</span><span class="token punctuation">:</span> <span class="token string">'db'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">USER</span><span class="token punctuation">:</span> <span class="token string">'wp'</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'123'</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'123'</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 先要用 ConfigMap 定义数据库的环境变量，有 DATABASE、USER、PASSWORD、ROOT_PASSWORD</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">:</span><span class="token number">10</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb</pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token key atrule">envFrom</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">'MARIADB_'</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>cm</pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># 为 MariaDB 定义一个 Service 对象，映射端口 3306</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># 让其他应用不再关心 IP 地址，直接用 Service 对象的名字来访问数据库服务</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> maria<span class="token punctuation">-</span>dep</pre></td></tr></table></figure><h3 id="部署-wordpress"><a class="anchor" href="#部署-wordpress">#</a> 部署 WordPress</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 因为刚才创建了 MariaDB 的 Service，所以在写 ConfigMap 配置的时候 “HOST” 就不应该是 IP 地址了，而应该是 DNS 域名，也就是 Service 的名字 maria-svc，这点需要特别注意</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>cm</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">HOST</span><span class="token punctuation">:</span> <span class="token string">'maria-svc'</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">USER</span><span class="token punctuation">:</span> <span class="token string">'wp'</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'123'</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">NAME</span><span class="token punctuation">:</span> <span class="token string">'db'</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># WordPress 的 Deployment 写法和 MariaDB 也是一样的，给 Pod 套一个 Deployment 的 “外壳”，replicas 设置成 2 个，用字段 “envFrom” 配置环境变量。</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span><span class="token number">5</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress</pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token key atrule">envFrom</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">'WORDPRESS_DB_'</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>cm</pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># 然后我们仍然要为 WordPress 创建 Service 对象，这里我使用了 “NodePort” 类型，并且手工指定了端口号 “30088”（必须在 30000~32767 之间）</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http80</pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30088</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</pre></td></tr></table></figure><h3 id="部署-nginx-ingress-controller"><a class="anchor" href="#部署-nginx-ingress-controller">#</a> 部署 Nginx Ingress Controller</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 首先我们需要定义 Ingress Class，名字就叫 “wp-ink”</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> IngressClass</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>ink</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">controller</span><span class="token punctuation">:</span> nginx.org/ingress<span class="token punctuation">-</span>controller</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># kubectl create ing wp-ing --rule="wp.test/=wp-svc:80" --class=wp-ink $out</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>ing</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>ink</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> wp.test</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">http</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">paths</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token key atrule">backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">service</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token key atrule">port</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># 接下来就是最关键的 Ingress Controller 对象了，它仍然需要从 Nginx 项目的示例 YAML 修改而来，要改动名字、标签，还有参数里的 Ingress Class。</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># 在之前讲基本架构的时候我说过了，这个 Ingress Controller 不使用 Service，而是给它的 Pod 加上一个特殊字段 hostNetwork，让 Pod 能够使用宿主机的网络，相当于另一种形式的 NodePort。</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>kic<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress</pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>kic<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>kic<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress</pre></td></tr><tr><td data-num="53"></td><td><pre>      </pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx/nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">:</span>2.2<span class="token punctuation">-</span>alpine</pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress</pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token key atrule">args</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          <span class="token punctuation">-</span> <span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>class=wp<span class="token punctuation">-</span>ink</pre></td></tr></table></figure><h1 id="数据持久化"><a class="anchor" href="#数据持久化">#</a> 数据持久化</h1><h2 id="persistentvolume"><a class="anchor" href="#persistentvolume">#</a> PersistentVolume</h2><ul><li>由于临时存储，pod 销毁后数据会丢失</li><li><code>PersistentVolume</code> 对象，它专门用来表示持久存储设备，但隐藏了存储的底层实现</li><li>PV 属于集群的系统资源，是和 Node 平级的一种对象，Pod 对它没有管理权，只有使用权</li></ul><h2 id="persistentvolumeclaim"><a class="anchor" href="#persistentvolumeclaim">#</a> PersistentVolumeClaim</h2><p><code>PersistentVolumeClaim</code> ，简称 PVC，从名字上看比较好理解，就是用来向 Kubernetes 申请存储资源的。PVC 是给 Pod 使用的对象，它相当于是 Pod 的代理，代表 Pod 向系统申请 PV。一旦资源申请成功，Kubernetes 就会把 PV 和 PVC 关联在一起，这个动作叫做 <strong>“绑定”</strong>（bind）。</p><h2 id="storageclass"><a class="anchor" href="#storageclass">#</a> StorageClass</h2><p>它抽象了特定类型的存储系统（比如 Ceph、NFS），在 PVC 和 PV 之间充当 “协调人” 的角色，帮助 PVC 找到合适的 PV。也就是说它可以简化 Pod 挂载 “虚拟盘” 的过程，让 Pod 看不到 PV 的实现细节。</p><p><img data-src="https://s2.loli.net/2024/02/17/BwKCOmptfjrGNou.png" alt=""></p><h2 id="描述-pv"><a class="anchor" href="#描述-pv">#</a> 描述 PV</h2><h3 id="样板-8"><a class="anchor" href="#样板-8">#</a> 样板</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>10m<span class="token punctuation">-</span>pv</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>test</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteOnce</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Mi</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">hostPath</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp/host<span class="token punctuation">-</span>10m<span class="token punctuation">-</span>pv/</pre></td></tr></table></figure><p>因为 Pod 会在集群的任意节点上运行，所以首先，我们要作为系统管理员在每个节点上创建一个目录，它将会作为本地存储卷挂载到 Pod 里。</p><h3 id="字段解释"><a class="anchor" href="#字段解释">#</a> 字段解释</h3><ul><li><p><strong>storageClassName</strong> 对存储类型的抽象 <code>StorageClass</code></p></li><li><p><strong>accessModes</strong> 定义了存储设备的访问模式，简单来说就是虚拟盘的读写权限，和 Linux 的文件访问模式差不多，目前 Kubernetes 里有 3 种：</p><ul><li>ReadWriteOnce：存储卷可读可写，但只能被一个节点上的 Pod 挂载。</li><li>ReadOnlyMany：存储卷只读不可写，可以被任意节点上的 Pod 多次挂载。</li><li>ReadWriteMany：存储卷可读可写，也可以被任意节点上的 Pod 多次挂载。</li></ul><p>这 3 种访问模式限制的对象是节点而不是 Pod</p><p>显然，本地目录只能是在本机使用，所以这个 PV 使用了 <code>ReadWriteOnce</code></p></li><li><p><strong>capacity 表示存储设备的容量</strong>（Kubernetes 里定义存储容量使用的是国际标准，我们日常习惯使用的 KB/MB/GB 的基数是 1024，<strong>要写成 Ki/Mi/Gi</strong>，一定要小心不要写错了，否则单位不一致实际容量就会对不上。）</p></li><li><p><strong>hostPath</strong> 指定了存储卷的本地路径，也就是我们在节点上创建的目录。</p></li></ul><h2 id="描述-pvc"><a class="anchor" href="#描述-pvc">#</a> 描述 PVC</h2><h3 id="样板-9"><a class="anchor" href="#样板-9">#</a> 样板</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>5m<span class="token punctuation">-</span>pvc</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>test</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">-</span> ReadWriteOnce</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Mi</pre></td></tr></table></figure><h3 id="字段解释-2"><a class="anchor" href="#字段解释-2">#</a> 字段解释</h3><p>PVC 的内容与 PV 很像，但它不表示实际的存储，而是一个 “申请” 或者 “声明”，spec 里的字段描述的是对存储的 “期望状态”</p><ul><li><p><code>storageClassName</code> <code>accessModes</code> <code>capacity</code> 和 PV 一样没有 <code>capacity</code></p></li><li><p><strong>resources.request</strong> 表示希望要有多大的容量</p></li></ul><p>这样，Kubernetes 就会根据 PVC 里的描述，去找能够匹配 StorageClass 和容量的 PV，然后把 PV 和 PVC “绑定” 在一起，实现存储的分配 。</p><h2 id="使用-2"><a class="anchor" href="#使用-2">#</a> 使用</h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 PV 对象</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl apply <span class="token parameter variable">-f</span> host-path-pv.yml</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查看状态</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kubectl get <span class="token function">pv</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 创建 PVC 对象，申请储存资源</span></pre></td></tr><tr><td data-num="6"></td><td><pre>kubectl apply <span class="token parameter variable">-f</span> host-path-pvc.yml</pre></td></tr><tr><td data-num="7"></td><td><pre>kubectl get pvc</pre></td></tr></table></figure><p>一旦 PVC 对象创建成功，Kubernetes 就会立即通过 StorageClass、resources 等条件在集群里查找符合要求的 PV，如果找到合适的存储对象就会把它俩 <strong>“绑定”</strong> 在一起。</p><h2 id="为-pod-挂载-pv"><a class="anchor" href="#为-pod-挂载-pv">#</a> 为 Pod 挂载 PV</h2><ul><li><p>先要在 <code>spec.volumes</code> 定义存储卷，然后在 <code>containers.volumeMounts</code> 挂载进容器</p></li><li><p><strong>要在 volumes 里用字段 persistentVolumeClaim 指定 PVC 的名字</strong></p></li></ul><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>5m<span class="token punctuation">-</span>pvc <span class="token comment"># 指定 PVC 名字</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp <span class="token comment"># 挂载路径</span></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/359FpSt8QGqcMXk.png" alt="pv.png"></p><p>因为 Pod 产生的数据已经通过 PV 存在了磁盘上，所以如果 Pod 删除后再重新创建，挂载存储卷时会依然使用这个目录，数据保持不变，也就实现了持久化存储。</p><h2 id="缺点"><a class="anchor" href="#缺点">#</a> 缺点</h2><ul><li>因为这个 PV 是 HostPath 类型，只在本节点存储，如果 Pod 重建时被调度到了其他节点上，那么即使加载了本地目录，也不会是之前的存储位置，持久化功能也就失效了</li><li>所以，HostPath 类型的 PV 一般用来做测试，或者是用于 DaemonSet 这样与节点关系比较密切的应用</li></ul><h2 id="总结-2"><a class="anchor" href="#总结-2">#</a> 总结</h2><ol><li><p>PersistentVolume 简称为 PV，是 Kubernetes 对存储设备的抽象，由系统管理员维护，需要描述清楚存储设备的类型、访问模式、容量等信息。</p></li><li><p>PersistentVolumeClaim 简称为 PVC，代表 Pod 向系统<strong>申请存储资源</strong>，它声明对存储的要求，Kubernetes 会查找<strong>最合适</strong>的 PV 然后绑定。</p></li><li><p>StorageClass 抽象特定类型的存储系统，归类分组 PV 对象，用来<strong>简化 PV/PVC 的绑定过程</strong>。</p></li><li><p>HostPath 是<strong>最简单</strong>的一种 PV，数据存储在节点本地，速度快但<strong>不能跟随 Pod 迁移</strong>。</p></li></ol><h1 id="pvnfs-网络共享存储"><a class="anchor" href="#pvnfs-网络共享存储">#</a> PV+NFS - 网络共享存储</h1><h2 id="安装-nfs-服务器和客户端"><a class="anchor" href="#安装-nfs-服务器和客户端">#</a> 安装 NFS 服务器和客户端</h2><p>详见同一类别下另一篇</p><h2 id="使用-nfs-存储卷"><a class="anchor" href="#使用-nfs-存储卷">#</a> 使用 NFS 存储卷</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># nfs-static-pv.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>1g<span class="token punctuation">-</span>pv</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp/nfs/1g<span class="token punctuation">-</span>pv <span class="token comment"># 共享目录名，路径须提前在服务端创建好</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.10.104 <span class="token comment"># 服务端主机</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 注意：不需要挂载本机目录</span></pre></td></tr></table></figure><ul><li><p>需要指定 <code>storageClassName</code> 是 <code>nfs</code> ，而 <code>accessModes</code> 可以设置成 <code>ReadWriteMany</code> ，这是由 <code>NFS</code> 的特性决定的，它支持多个节点同时访问一个共享目录</p></li><li><p>因为这个存储卷是 <code>NFS</code> 系统，所以我们还需要在 <code>YAML</code> 里添加 <code>nfs</code> 字段，指定 <code>NFS</code> 服务器的 <code>IP</code> 地址和共享目录名</p></li><li><p>这里在 <code>NFS</code> 服务器的 <code>/tmp/nfs</code> 目录里又创建了一个新的目录 <code>1g-pv</code> ，表示分配了 1GB 的可用存储空间，相应的， <code>PV</code> 里的 <code>capacity</code> 也要设置成同样的数值，也就是 1Gi</p></li></ul><p><strong>用 pvc 申请储存</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># nfs-static-pvc.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pvc</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># nfs-static-pod.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pvc</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>test</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp <span class="token comment"># 把 pod 的 /tmp 目录挂载到 nfs 服务端   即 /tmp/ 数据会写入共享目录</span></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/83VlJ472AcjsnGN.png" alt="pvc.png"></p><h2 id="部署-nfs-动态存储卷"><a class="anchor" href="#部署-nfs-动态存储卷">#</a> 部署 NFS 动态存储卷</h2><h2 id="使用-nfs-动态存储卷"><a class="anchor" href="#使用-nfs-动态存储卷">#</a> 使用 NFS 动态存储卷</h2><p>因为有了 <code>Provisioner</code> ，我们就不再需要手工定义 <code>PV</code> 对象了，只需要在 <code>PVC</code> 里指定 <code>StorageClass</code> 对象，它再关联到 <code>Provisioner</code></p><p>我们来看一下 NFS 默认的 <code>StorageClass</code> 定义：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">provisioner</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>sigs.io/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">parameters</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">"false"</span></pre></td></tr></table></figure><p>YAML 里的关键字段是 provisioner，它指定了应该使用哪个 Provisioner。另一个字段 parameters 是调节 Provisioner 运行的参数，需要参考文档来确定具体值，在这里的 <code>archiveOnDelete: &quot;false&quot;</code> 就是自动回收存储空间。</p><p>你也可以不使用默认的 StorageClass，而是根据自己的需求，任意定制具有不同存储特性的 StorageClass，比如添加字段 onDelete: &quot;retain&quot; 暂时保留分配的存储，之后再手动删除：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>retained</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">provisioner</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>sigs.io/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">parameters</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">onDelete</span><span class="token punctuation">:</span> <span class="token string">"retain"</span></pre></td></tr></table></figure><p>接下来我们定义一个 <code>PVC</code> ，向系统申请 10MB 的存储空间，使用的 <code>StorageClass</code> 是默认的 <code>nfs-client</code></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>dyn<span class="token punctuation">-</span>10m<span class="token punctuation">-</span>pvc</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Mi</pre></td></tr></table></figure><p>写好了 <code>PVC</code> ，我们还是在 <code>Pod</code> 里用 <code>volumes</code> 和 <code>volumeMounts</code> 挂载，然后 <code>Kubernetes</code> 就会自动找到 <code>NFS Provisioner</code> ，在 <code>NFS</code> 的共享目录上创建出合适的 <code>PV</code> 对象</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>dyn<span class="token punctuation">-</span>pod</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>dyn<span class="token punctuation">-</span>10m<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>dyn<span class="token punctuation">-</span>10m<span class="token punctuation">-</span>pvcSnipaste_2024<span class="token punctuation">-</span>02<span class="token punctuation">-</span>13_18<span class="token punctuation">-</span>04<span class="token punctuation">-</span><span class="token number">00</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>dyn<span class="token punctuation">-</span>test</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>dyn<span class="token punctuation">-</span>10m<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp</pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/Mlvc1brNP5dwoLG.png" alt=""></p><h2 id="总结-3"><a class="anchor" href="#总结-3">#</a> 总结</h2><p>本节我们引入了网络存储系统，以 NFS 为例研究了静态存储卷和动态存储卷的用法，其中的核心对象是 StorageClass 和 Provisioner。</p><ol><li><p>在 Kubernetes 集群里，网络存储系统更适合数据持久化，NFS 是最容易使用的一种网络存储系统，要事先安装好服务端和客户端。</p></li><li><p>可以编写 PV 手工定义 NFS 静态存储卷，要指定 NFS 服务器的 IP 地址和共享目录名。</p></li><li><p>使用 NFS 动态存储卷<strong>必须要部署相应的 Provisioner</strong>，在 YAML 里正确配置 NFS 服务器。</p></li><li><p>动态存储卷不需要手工定义 PV，而是要定义 StorageClass，<strong>由关联的 Provisioner 自动创建 PV 完成绑定</strong>。</p></li><li><p>StorageClass 里面的 OnDelete 、 archiveOnDelete 源自 PV 的存储回收策略，指定 PV 被销毁时数据是保留 Retain 还是 删除 Delete。</p></li></ol><h2 id="storageclass-的作用"><a class="anchor" href="#storageclass-的作用">#</a> StorageClass 的作用</h2><p>StorageClass 作用是帮助指定特定类型的 provisioner，这决定了你要使用的具体<strong>某种类型的存储插件</strong>；另外它还<strong>限定了 PV 和 PVC 的绑定关系</strong>，只有从属于同一 StorageClass 的 PV 和 PVC 才能做绑定动作，比如指定 GlusterFS 类型的 PVC 对象不能绑定到另外一个 PVC 定义的 NFS 类型的 StorageClass 模版创建出的 Volume 的 PV 对象上面去。</p><p>StorageClass 应证了 “所有问题都可以通过增加一层来解决”。作用是解决了特定底层存储与 K8S 上资源的解耦问题，通过 SC 统一接口，具体厂商负责具体的存储实现。</p><p>因为存储它涉及到了对物理机文件系统绑定的操作，因此 K8S 做了一系列抽象。PV 在这个抽象里，其实就指代了主机文件系统的路径，当然至于再往实现层面走，是网络文件系统还是主机文件系统，这就全由 PV 的绑定类型决定。而往抽象层走，作为 K8S 的核心系统，K8S 想尽可能屏蔽掉底层，也就是主机文件系统的概念，所以它抽象了 StorageClass ，用来统一指代 / 管理 PV 。至此，K8S 持久化存储就可以分两个部分：</p><p>第一部分是由 <strong>主机文件系统 + PV+StorageClass</strong> 组成的，用来将抽象对象绑定到真实文件系统的生产者部分；</p><p>第二部分就是 <strong>Volume+PVC+StorageClass</strong>，完全被抽象为 K8S 核心业务的消费者部分，而 StorageClass，可以看作是两部分连接的桥梁。</p><h1 id="statefulset-管理有状态的应用"><a class="anchor" href="#statefulset-管理有状态的应用">#</a> StatefulSet - 管理有状态的应用</h1><p>对于 “有状态应用”（如 mysql,redis），多个实例之间可能存在依赖关系，比如 master/slave、active/passive，需要<strong>依次启动</strong>才能保证应用正常运行，外界的客户端也可能要使用固定的网络标识来访问实例，而且这些信息还必须要保证在 Pod 重启后不变 。</p><ul><li>StatefulSet 也可以看做是 Deployment 的一个特例</li></ul><h2 id="样板-10"><a class="anchor" href="#样板-10">#</a> 样板</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5<span class="token punctuation">-</span>alpine</pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> redis</pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></pre></td></tr></table></figure><ul><li><p><code>spec</code> 里多出 <code>serviceName</code></p></li><li><p>其余和 <code>deployment</code> 相同</p></li></ul><h2 id="使用-statefulset"><a class="anchor" href="#使用-statefulset">#</a> 使用 StatefulSet</h2><p>写 service，metadata.name 必须和 StatefulSet 里的 serviceName 相同，selector 里的标签也必须和 StatefulSet 里的一致 。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></pre></td></tr></table></figure><ul><li>Service 自己会有一个域名，格式是 “<strong>对象名。名字空间</strong>”</li><li>Service 发现这些 Pod 不是一般的应用，而是有状态应用，需要有稳定的网络标识，所以就会为 Pod 再多创建出一个新的域名，格式是 <strong>“Pod 名。服务名。名字空间.svc.cluster.local”</strong>。当然，这个域名也可以简写成 <strong>“Pod 名。服务名”</strong>。</li></ul><p><img data-src="https://s2.loli.net/2024/02/17/rKXqyGgMiHL4uT2.png" alt="sts.png"></p><h2 id="statefulset-的数据持久化"><a class="anchor" href="#statefulset-的数据持久化">#</a> StatefulSet 的数据持久化</h2><p>为了强调持久化存储与 StatefulSet 的一对一绑定关系，Kubernetes 为 StatefulSet 专门定义了一个字段 <strong>“volumeClaimTemplates”</strong>，直接把 PVC 定义嵌入 StatefulSet 的 YAML 文件里。这样能保证创建 StatefulSet 的同时，就会为每个 Pod 自动创建 PVC，让 StatefulSet 的可用性更高。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>sts</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span> <span class="token comment"># pvc</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>100m<span class="token punctuation">-</span>pvc</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 100Mi</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>sts <span class="token comment"># 对应 svc 的名字</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>sts</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5<span class="token punctuation">-</span>alpine</pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> redis</pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>100m<span class="token punctuation">-</span>pvc</pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data</pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/02/17/vmfzyEXkgb4ULac.png" alt="sts1.png"></p><h2 id="总结-4"><a class="anchor" href="#总结-4">#</a> 总结</h2><p>我们学习了专门部署 “有状态应用” 的 API 对象 StatefulSet，它与 Deployment 非常相似，区别是由它管理的 Pod 会有<strong>固定的名字、启动顺序和网络标识</strong>，这些特性对于在集群里实施有主从、主备等关系的应用非常重要。</p><ol><li><p>StatefulSet 的 YAML 描述和 Deployment 几乎完全相同，<strong>只是多了一个关键字段</strong> <code>serviceName</code> 。</p></li><li><p>要为 StatefulSet 里的 Pod 生成<strong>稳定的域名</strong>，需要定义 Service 对象，它的名字必须和 StatefulSet 里的 <code>serviceName</code> 一致。</p></li><li><p>访问 StatefulSet 应该使用每个 Pod 的单独域名，形式是 “Pod 名。服务名”，<strong>不应该使用 Service 的负载均衡功能</strong>。</p></li><li><p>在 StatefulSet 里可以用字段 “volumeClaimTemplates” <strong>直接定义 PVC</strong>，让 Pod 实现数据持久化存储。</p></li></ol><h1 id="滚动更新-平滑的应用升级"><a class="anchor" href="#滚动更新-平滑的应用升级">#</a> 滚动更新 - 平滑的应用升级</h1><p>在 Kubernetes 里应用都是以 Pod 的形式运行的，而 Pod 通常又会被 Deployment 等对象来管理，<strong>所以应用的 “版本更新” 实际上更新的是整个 Pod。</strong></p><h2 id="滚动更新条件"><a class="anchor" href="#滚动更新条件">#</a> 滚动更新条件</h2><ul><li>镜像版本更新</li><li>镜像名称不变（可以再创建一个 yaml 文件）</li></ul><h2 id="常用命令"><a class="anchor" href="#常用命令">#</a> 常用命令</h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看应用更新的状态</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl rollout status deploy mysql-dep-test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查看 pod 变化情况</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kubectl describe deploy mysql-dep-test</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 暂停更新</span></pre></td></tr><tr><td data-num="6"></td><td><pre>kubectl rollout pause deploy mysql-dep-test</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 继续更新</span></pre></td></tr><tr><td data-num="8"></td><td><pre>kubectl rollout resume deploy mysql-dep-test</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 查看更新历史</span></pre></td></tr><tr><td data-num="10"></td><td><pre>kubectl rollout <span class="token function">history</span> deploy mysql-dep-test</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 查看每个版本详细信息</span></pre></td></tr><tr><td data-num="12"></td><td><pre>kubectl rollout <span class="token function">history</span> deploy  mysql-dep-test <span class="token parameter variable">--revision</span><span class="token operator">=</span><span class="token number">4</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 回退版本</span></pre></td></tr><tr><td data-num="14"></td><td><pre>kubectl rollout undo deploy mysql-dep-test</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 回退版本 - 指定版本</span></pre></td></tr><tr><td data-num="16"></td><td><pre>kubectl rollout undo deploy mysql-dep-test --to-revision<span class="token operator">=</span><span class="token number">2</span></pre></td></tr></table></figure><h2 id="添加更新描述"><a class="anchor" href="#添加更新描述">#</a> 添加更新描述</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">kubernetes.io/change-cause</span><span class="token punctuation">:</span> v1<span class="token punctuation">,</span> ngx=1.21</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">...</span> <span class="token punctuation">...</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">kubernetes.io/change-cause</span><span class="token punctuation">:</span> update to v2<span class="token punctuation">,</span> ngx=1.22</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">...</span> <span class="token punctuation">...</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">kubernetes.io/change-cause</span><span class="token punctuation">:</span> update to v3<span class="token punctuation">,</span> change name</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">...</span> <span class="token punctuation">...</span></pre></td></tr></table></figure><ul><li><code>annotations</code> 里的值可以任意写，Kubernetes 会自动忽略不理解的 Key-Value，但要编写更新说明就需要使用特定的字段 <code>kubernetes.io/change-cause</code></li></ul><h1 id="健康运行"><a class="anchor" href="#健康运行">#</a> 健康运行</h1><h2 id="容器资源配额"><a class="anchor" href="#容器资源配额">#</a> 容器资源配额</h2><p><strong>只要在 Pod 容器的描述部分添加一个新字段 resources 即可</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>resources</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi</pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">limits</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 20m</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi</pre></td></tr></table></figure><ul><li><p>“<strong>requests</strong>”，意思是容器要申请的资源，也就是说要求 Kubernetes 在创建 Pod 的时候必须分配这里列出的资源，否则容器就无法运行。</p></li><li><p>“<strong>limits</strong>”，意思是容器使用资源的上限，不能超过设定值，否则就有可能被强制停止运行。</p></li></ul><p>而 CPU 因为在计算机中数量有限，非常宝贵，所以 Kubernetes 允许容器精细分割 CPU，即可以 1 个、2 个地完整使用 CPU，也可以用小数 0.1、0.2 的方式来部分使用 CPU。这其实是效仿了 UNIX “时间片” 的用法，意思是进程最多可以占用多少 CPU 时间。</p><p>不过 CPU 时间也不能无限分割，<strong>Kubernetes 里 CPU 的最小使用单位是 0.001，为了方便表示用了一个特别的单位 m</strong>，也就是 “milli”“毫” 的意思，比如说 500m 就相当于 0.5。</p><p>现在我们再来看这个 YAML，你就应该明白了，它向系统<strong>申请</strong>的是 <strong>1% 的 CPU 时间和 100MB 的内存</strong>，运行时的<strong>资源上限</strong>是 <strong>2% CPU 时间和 200MB</strong> 内存。</p><p>如果 Pod 不写 <code>resources</code> 字段，Kubernetes 会如何处理呢？</p><p>这就意味着 Pod 对运行的资源要求 “既没有下限，也没有上限”，Kubernetes 不用管 CPU 和内存是否足够，可以把 Pod 调度到任意的节点上，而且后续 Pod 运行时也可以无限制地使用 CPU 和内存。</p><h2 id="容器状态探针"><a class="anchor" href="#容器状态探针">#</a> 容器状态探针</h2><p>Kubernetes 为检查应用状态定义了三种探针，它们分别对应容器不同的状态：</p><ul><li><p><strong>Startup</strong>，启动探针，用来检查应用是否已经启动成功，适合那些有大量初始化工作要做，启动很慢的应用。</p></li><li><p><strong>Liveness</strong>，存活探针，用来检查应用是否正常运行，是否存在死锁、死循环。</p></li><li><p><strong>Readiness</strong>，就绪探针，用来检查应用是否可以接收流量，是否能够对外提供服务。</p></li></ul><p>这三种探针是递进的关系：应用程序先启动，加载完配置文件等基本的初始化数据就进入了 Startup 状态，之后如果没有什么异常就是 Liveness 存活状态，但可能有一些准备工作没有完成，还不一定能对外提供服务，只有到最后的 Readiness 状态才是一个容器最健康可用的状态。</p><p><img data-src="https://s2.loli.net/2024/02/17/T9NSDE4tuFOrVa6.png" alt="probe.png"></p><p>如果一个 Pod 里的容器配置了探针，<strong>Kubernetes 在启动容器后就会不断地调用探针来检查容器的状态</strong>：</p><ul><li><p>如果 Startup 探针失败，Kubernetes 会认为容器没有正常启动，就会尝试<strong>反复重启</strong>，当然其后面的 Liveness 探针和 Readiness 探针也不会启动。</p></li><li><p>如果 Liveness 探针失败，Kubernetes 就会认为容器发生了异常，也会<strong>重启容器</strong>。</p></li><li><p>如果 Readiness 探针失败，Kubernetes 会认为容器虽然在运行，但内部有错误，不能正常提供服务，就会把容器从 Service 对象的<strong>负载均衡集合中排除，不会给它分配流量</strong>。</p></li></ul><p><img data-src="https://s2.loli.net/2024/02/17/5OGVFavEDe1klbo.png" alt="probe1.png"></p><h2 id="如何使用容器状态探针"><a class="anchor" href="#如何使用容器状态探针">#</a> 如何使用容器状态探针</h2><p>startupProbe、livenessProbe、readinessProbe 这三种探针的配置方式都是一样的，关键字段有这么几个：</p><ul><li><strong>periodSeconds</strong>，执行探测动作的<strong>时间间隔</strong>，默认是 10 秒探测一次。</li><li><strong>timeoutSeconds</strong>，探测动作的<strong>超时时间</strong>，如果超时就认为探测失败，默认是 1 秒。</li><li><strong>successThreshold</strong>，<strong>连续几次探测成功</strong>才认为是正常，对于 startupProbe 和 livenessProbe 来说它只能是 1。</li><li><strong>failureThreshold</strong>，<strong>连续探测失败几次</strong>才认为是真正发生了异常，默认是 3 次。</li></ul><p>至于<strong>探测方式</strong>，Kubernetes 支持 3 种：Shell、TCP Socket、HTTP GET，它们也需要在探针里配置：</p><ul><li><strong>exec</strong>，执行一个 Linux 命令，比如 ps、cat 等等，和 container 的 command 字段很类似。</li><li><strong>tcpSocket</strong>，使用 TCP 协议尝试连接容器的指定端口。</li><li><strong>httpGet</strong>，连接端口并发送 HTTP GET 请求。</li></ul><h3 id="示例"><a class="anchor" href="#示例">#</a> 示例</h3><p><strong>ConfigMap</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>conf</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">default.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    server &#123;</pre></td></tr><tr><td data-num="9"></td><td><pre>      listen 80;</pre></td></tr><tr><td data-num="10"></td><td><pre>      location = /ready &#123;</pre></td></tr><tr><td data-num="11"></td><td><pre>        return 200 'I am ready';</pre></td></tr><tr><td data-num="12"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num="13"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 启用了 80 端口，然后用 location 指令定义了 HTTP 路径 /ready，它作为对外暴露的 “检查口”，用来检测就绪状态，返回简单的 200 状态码和一个字符串表示工作正常。</span></pre></td></tr></table></figure><p><strong>Pod</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>probe</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>conf<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">configMap</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>conf</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d</pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>conf<span class="token punctuation">-</span>vol</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">startupProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">exec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"/var/run/nginx.pid"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># StartupProbe 使用了 Shell 方式，使用 cat 命令检查 Nginx 存在磁盘上的进程号文件（/var/run/nginx.pid），如果存在就认为是启动成功，它的执行频率是每秒探测一次。</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># LivenessProbe 使用了 TCP Socket 方式，尝试连接 Nginx 的 80 端口，每 10 秒探测一次。</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /ready</pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># ReadinessProbe 使用的是 HTTP GET 方式，访问容器的 /ready 路径，每 5 秒发一次请求。</span></pre></td></tr></table></figure><h1 id="名字空间"><a class="anchor" href="#名字空间">#</a> 名字空间</h1><p>**Kubernetes 的名字空间并不是一个实体对象，只是一个逻辑上的概念。** 它可以把集群切分成一个个彼此独立的区域，然后我们把对象放到这些区域里，就实现了类似容器技术里 namespace 的隔离效果，应用只能在自己的名字空间里分配资源和运行，不会干扰到其他名字空间里的应用。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建名字空间</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl create ns test-ns </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 获取名字空间</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kubectl get ns</pre></td></tr></table></figure><p><strong>也可以这样创建名字空间</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>ns</pre></td></tr></table></figure><p><strong>想要把一个对象放入特定的名字空间，需要在它的 metadata 里添加一个 namespace 字段</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>ns</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx</pre></td></tr></table></figure><p><strong>想要操作其他名字空间的对象必须要用 -n 参数明确指定</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl get pod <span class="token parameter variable">-n</span> test-ns</pre></td></tr></table></figure><p><strong>一旦名字空间被删除，它里面的所有对象也都会消失</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>kubectl delete ns test-ns</pre></td></tr></table></figure><h2 id="资源配额-resourcequota"><a class="anchor" href="#资源配额-resourcequota">#</a> 资源配额 - ResourceQuota</h2><p>有了名字空间，我们就可以像管理容器一样，给名字空间设定配额，把整个集群的计算资源分割成不同的大小，按需分配给团队或项目使用</p><p><strong>名字空间的资源配额需要使用一个专门的 API 对象，叫做 ResourceQuota，简称是 quota</strong></p><p>ResourceQuota 对象的使用方式比较灵活，既可以限制整个名字空间的配额，也可以只限制某些类型的对象（使用 scopeSelector），今天我们看第一种，它需要在 <code>spec</code> 里使用 <code>hard</code> 字段，意思就是 <strong>“硬性全局限制”</strong>。</p><h3 id="样板-11"><a class="anchor" href="#样板-11">#</a> 样板</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>qt</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>ns</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">hard</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment"># 所有 Pod 的需求总量最多是 10 个 CPU 和 10GB 的内存，上限总量是 10 个 CPU 和 20GB 的内存</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">requests.cpu</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">requests.memory</span><span class="token punctuation">:</span> 10Gi</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">limits.cpu</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">limits.memory</span><span class="token punctuation">:</span> 20Gi</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment"># 只能创建 100 个 PVC 对象，使用 100GB 的持久化存储空间</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">requests.storage</span><span class="token punctuation">:</span> 100Gi</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">persistentvolumeclaims</span><span class="token punctuation">:</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment"># 只能创建 100 个 Pod，100 个 ConfigMap，100 个 Secret，10 个 Service</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">configmaps</span><span class="token punctuation">:</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">secrets</span><span class="token punctuation">:</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment"># 只能创建 1 个 Job，1 个 CronJob，1 个 Deployment</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">count/jobs.batch</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">count/cronjobs.batch</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">count/deployments.apps</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr></table></figure><h3 id="字段解释-3"><a class="anchor" href="#字段解释-3">#</a> 字段解释</h3><ul><li><p>CPU 和内存配额，使用 <code>request.*</code> 、 <code>limits.*</code> ，这是和容器资源限制是一样的。</p></li><li><p>存储容量配额，使 <code>requests.storage</code> 限制的是 PVC 的存储总量，也可以用 <code>persistentvolumeclaims</code> 限制 PVC 的个数。</p></li><li><p>核心对象配额，使用对象的名字（英语复数形式），比如 <code>pods</code> 、 <code>configmaps</code> 、 <code>secrets</code> 、 <code>services</code> 。</p></li><li><p>其他 API 对象配额，使用 <code>count/name.group</code> 的形式，比如 <code>count/jobs.batch</code> 、 <code>count/deployments.apps</code> 。</p></li></ul><h3 id="使用资源配额"><a class="anchor" href="#使用资源配额">#</a> 使用资源配额</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 部署 quota</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl apply <span class="token parameter variable">-f</span> quota-ns.yml</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查看对象</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kubectl get <span class="token function">quota</span> <span class="token parameter variable">-n</span> dev-ns</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看对象（更清晰）</span></pre></td></tr><tr><td data-num="6"></td><td><pre>kubectl describe <span class="token function">quota</span> <span class="token parameter variable">-n</span> dev-ns</pre></td></tr></table></figure><h2 id="limitrange"><a class="anchor" href="#limitrange">#</a> LimitRange</h2><ul><li>自动为 Pod 加上资源限制</li></ul><p><strong>很小但很有用的辅助对象了 —— LimitRange，简称是 limits，它能为 API 对象添加默认的资源配额限制。</strong></p><h3 id="样板-12"><a class="anchor" href="#样板-12">#</a> 样板</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>limits</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>ns</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">limits</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Container</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">defaultRequest</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 50Mi</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment"># 每个容器默认申请 0.2 的 CPU 和 50MB 内存</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">default</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token comment"># 容器的资源上限是 0.5 的 CPU 和 100MB 内存</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">max</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 800m</pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi</pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token comment"># 每个 Pod 的最大使用量是 0.8 的 CPU 和 200MB 内存</span></pre></td></tr></table></figure><h3 id="字段解释-4"><a class="anchor" href="#字段解释-4">#</a> 字段解释</h3><ul><li><p><code>spec.limits</code> 是它的核心属性，描述了默认的资源限制。</p></li><li><p><code>type</code> 是要限制的对象类型，可以是 <code>Container</code> 、 <code>Pod</code> 、 <code>PersistentVolumeClaim</code> 。</p></li><li><p><code>default</code> 是默认的资源上限，对应容器里的 <code>resources.limits</code> ，只适用于 <code>Container</code> 。</p></li><li><p><code>defaultRequest</code> 默认申请的资源，对应容器里的 <code>resources.requests</code> ，同样也只适用于 <code>Container</code> 。</p></li><li><p><code>max</code> 、 <code>min</code> 是对象能使用的资源的最大最小值。</p></li></ul><h2 id="总结-5"><a class="anchor" href="#总结-5">#</a> 总结</h2><p>在生产环境里会有很多用户共同使用 Kubernetes，必然会有对资源的竞争，为了公平起见，避免某些用户过度消耗资源，就非常有必要用名字空间做好集群的资源规划了。</p><ol><li><p>名字空间是一个逻辑概念，没有实体，它的目标是为资源和对象划分出一个逻辑边界，避免冲突。</p></li><li><p>ResourceQuota 对象可以为名字空间添加资源配额，限制全局的 CPU、内存和 API 对象数量。</p></li><li><p>LimitRange 对象可以为容器或者 Pod 添加默认的资源配额，简化对象的创建工作。</p></li></ol><h1 id="系统监控"><a class="anchor" href="#系统监控">#</a> 系统监控</h1><h2 id="metric-server"><a class="anchor" href="#metric-server">#</a> metric-server</h2><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># components.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-admin</span><span class="token punctuation">:</span> <span class="token string">"true"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="token punctuation">:</span> <span class="token string">"true"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-view</span><span class="token punctuation">:</span> <span class="token string">"true"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>aggregated<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>reader</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">-</span> metrics.k8s.io</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">-</span> pods</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">-</span> nodes</pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">-</span> get</pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">-</span> list</pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token punctuation">-</span> watch</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">-</span> nodes/metrics</pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token punctuation">-</span> get</pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token punctuation">-</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token punctuation">-</span> pods</pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">-</span> nodes</pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">-</span> get</pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token punctuation">-</span> list</pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token punctuation">-</span> watch</pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>reader</pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> extension<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>reader</pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding</pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator</pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator</pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding</pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="93"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https</pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> https</pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="125"></td><td><pre>      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="128"></td><td><pre>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="131"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="134"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="135"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>dir=/tmp</pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secure<span class="token punctuation">-</span>port=4443</pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>preferred<span class="token punctuation">-</span>address<span class="token punctuation">-</span>types=InternalIP<span class="token punctuation">,</span>ExternalIP<span class="token punctuation">,</span>Hostname</pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>use<span class="token punctuation">-</span>node<span class="token punctuation">-</span>status<span class="token punctuation">-</span>port</pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metric<span class="token punctuation">-</span>resolution=15s</pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>tls  <span class="token comment"># important</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.aliyuncs.com/google_containers/metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>v0.6.1</pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="145"></td><td><pre>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="146"></td><td><pre>          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="147"></td><td><pre>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /livez</pre></td></tr><tr><td data-num="148"></td><td><pre>            <span class="token key atrule">port</span><span class="token punctuation">:</span> https</pre></td></tr><tr><td data-num="149"></td><td><pre>            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS</pre></td></tr><tr><td data-num="150"></td><td><pre>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="152"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">4443</span></pre></td></tr><tr><td data-num="154"></td><td><pre>          <span class="token key atrule">name</span><span class="token punctuation">:</span> https</pre></td></tr><tr><td data-num="155"></td><td><pre>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="156"></td><td><pre>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="157"></td><td><pre>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="158"></td><td><pre>          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="159"></td><td><pre>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /readyz</pre></td></tr><tr><td data-num="160"></td><td><pre>            <span class="token key atrule">port</span><span class="token punctuation">:</span> https</pre></td></tr><tr><td data-num="161"></td><td><pre>            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS</pre></td></tr><tr><td data-num="162"></td><td><pre>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="163"></td><td><pre>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="165"></td><td><pre>          <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="166"></td><td><pre>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m</pre></td></tr><tr><td data-num="167"></td><td><pre>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi</pre></td></tr><tr><td data-num="168"></td><td><pre>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="169"></td><td><pre>          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="170"></td><td><pre>          <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="171"></td><td><pre>          <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="172"></td><td><pre>          <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span></pre></td></tr><tr><td data-num="173"></td><td><pre>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="174"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp</pre></td></tr><tr><td data-num="175"></td><td><pre>          <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir</pre></td></tr><tr><td data-num="176"></td><td><pre>      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="177"></td><td><pre>        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux</pre></td></tr><tr><td data-num="178"></td><td><pre>      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical</pre></td></tr><tr><td data-num="179"></td><td><pre>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="180"></td><td><pre>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="181"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir</pre></td></tr><tr><td data-num="183"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="184"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiregistration.k8s.io/v1</pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> APIService</pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="187"></td><td><pre>  <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="188"></td><td><pre>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="189"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> v1beta1.metrics.k8s.io</pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="191"></td><td><pre>  <span class="token key atrule">group</span><span class="token punctuation">:</span> metrics.k8s.io</pre></td></tr><tr><td data-num="192"></td><td><pre>  <span class="token key atrule">groupPriorityMinimum</span><span class="token punctuation">:</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="193"></td><td><pre>  <span class="token key atrule">insecureSkipTLSVerify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="194"></td><td><pre>  <span class="token key atrule">service</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="195"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server</pre></td></tr><tr><td data-num="196"></td><td><pre>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</pre></td></tr><tr><td data-num="197"></td><td><pre>  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1beta1</pre></td></tr><tr><td data-num="198"></td><td><pre>  <span class="token key atrule">versionPriority</span><span class="token punctuation">:</span> <span class="token number">100</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看集群里的节点</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kubectl <span class="token function">top</span> <span class="token function">node</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查看 pod 状态</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kubectl <span class="token function">top</span> pod <span class="token parameter variable">-n</span> kube-system</pre></td></tr></table></figure><h2 id="horizontalpodautoscaler"><a class="anchor" href="#horizontalpodautoscaler">#</a> HorizontalPodAutoscaler</h2><p>它是专门用来自动伸缩 Pod 数量的对象，适用于 Deployment 和 StatefulSet，但不能用于 DaemonSet 。</p><p>HorizontalPodAutoscaler 的能力完全基于 Metrics Server，它从 Metrics Server 获取当前应用的运行指标，主要是 CPU 使用率，再依据预定的策略增加或者减少 Pod 的数量。</p><p><strong>1. 首先定义 nginx 的 deploy 和 svc</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>hpa<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>hpa<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">labels</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>hpa<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 50m</pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Mi</pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token key atrule">limits</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m</pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 20Mi</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>hpa<span class="token punctuation">-</span>svc</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>hpa<span class="token punctuation">-</span>dep</pre></td></tr></table></figure><p><strong>注意在它的</strong> <code>spec</code> <strong>里一定要用 resources 字段写清楚资源配额</strong>，否则 HorizontalPodAutoscaler 会无法获取 Pod 的指标，也就无法实现自动化扩缩容。</p><p><strong>2. 创建 hpa</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>hpa</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment"># Pod 数量的最大值，也就是扩容的上限</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># Pod 数量的最小值，也就是缩容的下限</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span> <span class="token comment"># 以下参数对应上面的 deployment</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>hpa<span class="token punctuation">-</span>dep</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># CPU 使用率指标，当大于这个值时扩容，小于这个值时缩容</span></pre></td></tr></table></figure><h2 id="prometheus"><a class="anchor" href="#prometheus">#</a> Prometheus</h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://github.com/prometheus-operator/kube-prometheus/archive/refs/tags/v0.11.0.tar.gz</pre></td></tr></table></figure><h1 id="网络通信"><a class="anchor" href="#网络通信">#</a> 网络通信</h1><div class="tags"><a href="/tags/k8s/" rel="tag"><i class="ic i-tag"></i> k8s</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-02-17 19:56:56" itemprop="dateModified" datetime="2024-02-17T19:56:56+08:00">2024-02-17</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="镜玄 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="镜玄 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="镜玄 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>镜玄 <i class="ic i-at"><em>@</em></i>镜玄的博客</li><li class="link"><strong>本文链接：</strong> <a href="https://withoutabc.github.io/2024/02/13/%E8%BF%90%E7%BB%B4/Kubernetes%E5%9F%BA%E7%A1%80/" title="Kubernetes基础">https://withoutabc.github.io/2024/02/13/运维/Kubernetes基础/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/NFS%E9%85%8D%E7%BD%AE/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;07&#x2F;26&#x2F;h3IFdaBQOwAj8vL.jpg" title="NFS配置"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 运维</span><h3>NFS配置</h3></a></div><div class="item right"><a href="/2024/02/13/%E5%90%8E%E7%AB%AF/Sentinel/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;07&#x2F;24&#x2F;ERKTmSBrWPqz1H9.jpg" title="Sentinel"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 后端</span><h3>Sentinel</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#pod-%E6%94%B6%E7%BA%B3%E4%BB%93"><span class="toc-number">1.</span> <span class="toc-text">Pod-&quot;收纳仓&quot;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#container"><span class="toc-number">1.1.</span> <span class="toc-text">container</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5"><span class="toc-number">1.1.1.</span> <span class="toc-text">字段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%92%8C%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.</span> <span class="toc-text">复制和执行命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#job-%E4%B8%B4%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">Job-&quot;临时任务&quot;</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cronjob-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">CronJob-&quot;定时任务&quot;</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#configmapsecret"><span class="toc-number">4.</span> <span class="toc-text">ConfigMap&#x2F;Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#configmap"><span class="toc-number">4.1.</span> <span class="toc-text">ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF"><span class="toc-number">4.1.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#data-%E5%AD%97%E6%AE%B5"><span class="toc-number">4.1.2.</span> <span class="toc-text">data 字段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secret"><span class="toc-number">4.2.</span> <span class="toc-text">Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-2"><span class="toc-number">4.2.1.</span> <span class="toc-text">样板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8"><span class="toc-number">4.3.</span> <span class="toc-text">如何使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">4.3.1.</span> <span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volume-%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">4.3.2.</span> <span class="toc-text">Volume - 存储卷</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#deployment"><span class="toc-number">5.</span> <span class="toc-text">Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-3"><span class="toc-number">5.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5-2"><span class="toc-number">5.2.</span> <span class="toc-text">字段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#replicas"><span class="toc-number">5.2.1.</span> <span class="toc-text">replicas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#selector"><span class="toc-number">5.2.2.</span> <span class="toc-text">selector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%BC%B8%E7%BC%A9"><span class="toc-number">5.2.3.</span> <span class="toc-text">应用伸缩</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#daemonset"><span class="toc-number">6.</span> <span class="toc-text">DaemonSet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-4"><span class="toc-number">6.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6"><span class="toc-number">6.2.</span> <span class="toc-text">污点和容忍度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-master-%E5%92%8C-worker-%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">6.2.1.</span> <span class="toc-text">查看 Master 和 Worker 的状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E8%AE%A9-daemonset-%E5%9C%A8-master-%E8%8A%82%E7%82%B9%E6%88%96%E8%80%85%E4%BB%BB%E6%84%8F%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%BA%86"><span class="toc-number">6.3.</span> <span class="toc-text">怎么让 DaemonSet 在 Master 节点（或者任意其他节点）上运行了？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E9%99%A4%E6%B1%A1%E7%82%B9"><span class="toc-number">6.3.1.</span> <span class="toc-text">去除污点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-pod-%E5%AD%97%E6%AE%B5-tolerations"><span class="toc-number">6.3.2.</span> <span class="toc-text">添加 pod 字段 tolerations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%B1%A1%E7%82%B9"><span class="toc-number">6.3.3.</span> <span class="toc-text">(添加污点)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#service"><span class="toc-number">7.</span> <span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-5"><span class="toc-number">7.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E5%9F%9F%E5%90%8D%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BD%BF%E7%94%A8-service"><span class="toc-number">7.2.</span> <span class="toc-text">以域名的方式使用 service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A9-service-%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2"><span class="toc-number">7.3.</span> <span class="toc-text">让 Service 对外暴露</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ingressingress-class"><span class="toc-number">8.</span> <span class="toc-text">Ingress&#x2F;Ingress Class</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ingress"><span class="toc-number">8.1.</span> <span class="toc-text">Ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-6"><span class="toc-number">8.1.1.</span> <span class="toc-text">样板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ingress-class"><span class="toc-number">8.2.</span> <span class="toc-text">Ingress Class</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-7"><span class="toc-number">8.2.1.</span> <span class="toc-text">样板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">8.3.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#wordpress-%E9%83%A8%E7%BD%B2"><span class="toc-number">9.</span> <span class="toc-text">WordPress 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-mariadb"><span class="toc-number">9.1.</span> <span class="toc-text">部署 MariaDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-wordpress"><span class="toc-number">9.1.1.</span> <span class="toc-text">部署 WordPress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-nginx-ingress-controller"><span class="toc-number">9.1.2.</span> <span class="toc-text">部署 Nginx Ingress Controller</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">10.</span> <span class="toc-text">数据持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#persistentvolume"><span class="toc-number">10.1.</span> <span class="toc-text">PersistentVolume</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#persistentvolumeclaim"><span class="toc-number">10.2.</span> <span class="toc-text">PersistentVolumeClaim</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#storageclass"><span class="toc-number">10.3.</span> <span class="toc-text">StorageClass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0-pv"><span class="toc-number">10.4.</span> <span class="toc-text">描述 PV</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-8"><span class="toc-number">10.4.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%A7%A3%E9%87%8A"><span class="toc-number">10.4.2.</span> <span class="toc-text">字段解释</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0-pvc"><span class="toc-number">10.5.</span> <span class="toc-text">描述 PVC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-9"><span class="toc-number">10.5.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%A7%A3%E9%87%8A-2"><span class="toc-number">10.5.2.</span> <span class="toc-text">字段解释</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">10.6.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA-pod-%E6%8C%82%E8%BD%BD-pv"><span class="toc-number">10.7.</span> <span class="toc-text">为 Pod 挂载 PV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-number">10.8.</span> <span class="toc-text">缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">10.9.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pvnfs-%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8"><span class="toc-number">11.</span> <span class="toc-text">PV+NFS - 网络共享存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-nfs-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">11.1.</span> <span class="toc-text">安装 NFS 服务器和客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-nfs-%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">11.2.</span> <span class="toc-text">使用 NFS 存储卷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-nfs-%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">11.3.</span> <span class="toc-text">部署 NFS 动态存储卷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-nfs-%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">11.4.</span> <span class="toc-text">使用 NFS 动态存储卷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">11.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#storageclass-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">11.6.</span> <span class="toc-text">StorageClass 的作用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#statefulset-%E7%AE%A1%E7%90%86%E6%9C%89%E7%8A%B6%E6%80%81%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">12.</span> <span class="toc-text">StatefulSet - 管理有状态的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-10"><span class="toc-number">12.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-statefulset"><span class="toc-number">12.2.</span> <span class="toc-text">使用 StatefulSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#statefulset-%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">12.3.</span> <span class="toc-text">StatefulSet 的数据持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">12.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0-%E5%B9%B3%E6%BB%91%E7%9A%84%E5%BA%94%E7%94%A8%E5%8D%87%E7%BA%A7"><span class="toc-number">13.</span> <span class="toc-text">滚动更新 - 平滑的应用升级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E6%9D%A1%E4%BB%B6"><span class="toc-number">13.1.</span> <span class="toc-text">滚动更新条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">13.2.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%9B%B4%E6%96%B0%E6%8F%8F%E8%BF%B0"><span class="toc-number">13.3.</span> <span class="toc-text">添加更新描述</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E8%BF%90%E8%A1%8C"><span class="toc-number">14.</span> <span class="toc-text">健康运行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">14.1.</span> <span class="toc-text">容器资源配额</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81%E6%8E%A2%E9%92%88"><span class="toc-number">14.2.</span> <span class="toc-text">容器状态探针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81%E6%8E%A2%E9%92%88"><span class="toc-number">14.3.</span> <span class="toc-text">如何使用容器状态探针</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">14.3.1.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8D%E5%AD%97%E7%A9%BA%E9%97%B4"><span class="toc-number">15.</span> <span class="toc-text">名字空间</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D-resourcequota"><span class="toc-number">15.1.</span> <span class="toc-text">资源配额 - ResourceQuota</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-11"><span class="toc-number">15.1.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%A7%A3%E9%87%8A-3"><span class="toc-number">15.1.2.</span> <span class="toc-text">字段解释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">15.1.3.</span> <span class="toc-text">使用资源配额</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#limitrange"><span class="toc-number">15.2.</span> <span class="toc-text">LimitRange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9D%BF-12"><span class="toc-number">15.2.1.</span> <span class="toc-text">样板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%A7%A3%E9%87%8A-4"><span class="toc-number">15.2.2.</span> <span class="toc-text">字段解释</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-5"><span class="toc-number">15.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7"><span class="toc-number">16.</span> <span class="toc-text">系统监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#metric-server"><span class="toc-number">16.1.</span> <span class="toc-text">metric-server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#horizontalpodautoscaler"><span class="toc-number">16.2.</span> <span class="toc-text">HorizontalPodAutoscaler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prometheus"><span class="toc-number">16.3.</span> <span class="toc-text">Prometheus</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1"><span class="toc-number">17.</span> <span class="toc-text">网络通信</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/NFS%E5%8A%A8%E6%80%81%E5%8D%B7%E9%83%A8%E7%BD%B2yaml%E6%96%87%E4%BB%B6/" rel="bookmark" title="NFS动态卷部署yaml文件">NFS动态卷部署yaml文件</a></li><li><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/NFS%E9%85%8D%E7%BD%AE/" rel="bookmark" title="NFS配置">NFS配置</a></li><li class="active"><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/Kubernetes%E5%9F%BA%E7%A1%80/" rel="bookmark" title="Kubernetes基础">Kubernetes基础</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="镜玄" data-src="/images/avatar.jpg"><p class="name" itemprop="name">镜玄</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">15</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">5</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">14</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dpdGhvdXRhYmM=" title="https:&#x2F;&#x2F;github.com&#x2F;withoutabc"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOmZ3NTVmZnd3QG91dGxvb2suY29t" title="mailto:fw55ffww@outlook.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-magic"></i>链环</a><ul class="submenu"><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>朋友</a></li><li class="item"><a href="/websites/" rel="section"><i class="ic i-link-circle"></i>网址</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/NFS%E9%85%8D%E7%BD%AE/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/02/13/%E5%90%8E%E7%AB%AF/Sentinel/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E8%BF%90%E7%BB%B4/" title="分类于 运维">运维</a></div><span><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/NFS%E9%85%8D%E7%BD%AE/" title="NFS配置">NFS配置</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2023/12/18/%E5%90%8E%E7%AB%AF/Minio%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%BD%BF%E7%94%A8/" title="Minio部署及使用">Minio部署及使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/12/%E5%90%8E%E7%AB%AF/Rabbitmq/" title="Rabbitmq">Rabbitmq</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%BF%90%E7%BB%B4/" title="分类于 运维">运维</a></div><span><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/Kubernetes%E5%9F%BA%E7%A1%80/" title="Kubernetes基础">Kubernetes基础</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%BF%90%E7%BB%B4/" title="分类于 运维">运维</a></div><span><a href="/2024/02/13/%E8%BF%90%E7%BB%B4/NFS%E5%8A%A8%E6%80%81%E5%8D%B7%E9%83%A8%E7%BD%B2yaml%E6%96%87%E4%BB%B6/" title="NFS动态卷部署yaml文件">NFS动态卷部署yaml文件</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/13/%E5%90%8E%E7%AB%AF/Sentinel/" title="Sentinel">Sentinel</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a></div><span><a href="/2023/12/17/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%8F%89%E6%A0%91/" title="二叉树">二叉树</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2023/12/18/%E5%90%8E%E7%AB%AF/Nginx/" title="Nginx">Nginx</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/13/%E5%90%8E%E7%AB%AF/viper/" title="viper">viper</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a></div><span><a href="/2024/02/07/%E5%90%8E%E7%AB%AF/Traefik%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%BD%BF%E7%94%A8/" title="Traefik部署及使用">Traefik部署及使用</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">镜玄 @ 寄寄菜鸟试飞点</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">147k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2:13</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/02/13/运维/Kubernetes基础/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->